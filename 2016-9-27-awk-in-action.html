<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>awk实战与总结</title>
	<meta name="keywords" content="fzb.me,冯宗宝,冯宗宝的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />
    
        <script src="/js/util.js" type="text/javascript"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>


<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 class="title">awk实战与总结</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2016年9月27日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#awk简介"><span class="toc-text">awk简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#日志准备"><span class="toc-text">日志准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实战"><span class="toc-text">实战</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本列输出"><span class="toc-text">基本列输出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#过滤输出"><span class="toc-text">过滤输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内部变量"><span class="toc-text">内部变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义输出间隔"><span class="toc-text">自定义输出间隔</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字符串匹配"><span class="toc-text">字符串匹配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#文件拆分"><span class="toc-text">文件拆分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#统计"><span class="toc-text">统计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#awk脚本"><span class="toc-text">awk脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#环境变量"><span class="toc-text">环境变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考"><span class="toc-text">参考</span></a></li></ol>
<blockquote>
<p>这个问题在16年9月份,也就是在集中跟踪服务稳定性期间经常考虑，尽管它写于2017.08，但它属于2016.09。</p>
</blockquote>
<p>线上服务的稳定性一方面要从代码入手，另外一方面，亦可以通过日志暴露许多没有考虑进去的问题。在上线过程中，也有必要根据日志分析中找出小概率事件引起的问题，比较直观且有依据。</p>
<ul>
<li>可以从中寻找对应90-95分位的请求时间，作为服务的超时时间；</li>
<li>可以找寻对应的客户端排名等等。</li>
</ul>
<p>所以日志的分析是比较日常的行为。主要从利器awk入手，很有必要加强。</p>
<h3 id="awk简介"><a href="#awk简介" class="headerlink" title="awk简介"></a>awk简介</h3><p><code>awk</code>是取三位创始人 Alfred Aho、Peter Weinberger、 Brian Kernighan 的Family Name的首字符组合而成的程序语言。多么具有共创意识的典范，类似的还有zend，<code>awk</code>有一本相当经典的书《The AWK Programming Language》，在豆瓣上的评分是9.5，在亚马逊上已经卖到1505.00元。</p>
<p>15年的时候还在跟国峰争论将日志放置成一行的必要性，在后来的日志分析中才显得尤为重要。这一点就是在说日志分析时，方便分析工具的使用。</p>
<ul>
<li>根据nginx 找出HTTP状态码为499 5**的日志；</li>
<li>根据日志找出对应耗时最长的ip top10;</li>
</ul>
<h3 id="日志准备"><a href="#日志准备" class="headerlink" title="日志准备"></a>日志准备</h3><p>一个日志文件举例，内容包含错误级别、日期、文件、行号、错误码、上游IP、耗时、错误码、错误内容等，可以认为是一道需要入手分析的菜肴。<br><figure class="highlight"><figcaption><span>ral-worker.log部分</span></figcaption><table><tr><td class="code"><pre><span class="line">WARNING: 11-23 17:11:30:  ral-worker * 32072 [php_ral.cpp:1022][logid=690103304 worker_id=32213 optime=1479892290.111171 msg=ral_write_log log_type=E_SUM caller=Bd_DB from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=niux_yunying method=connect prot=mysql remote_ip=%3A3306 cost=0 connect=0 read=0 write=0 trans=0 dbname=niux_yunying sql= err_no=2013 err_info=Lost+connection+to+MySQL+server+at+%27waiting+for+initial+communication+packet%27%2C+system+error%3A+95]&#10;WARNING: 11-23 17:11:30:  ral-worker * 32072 [php_ral.cpp:1022][logid=690103304 worker_id=32213 optime=1479892290.111259 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=nuomi_yunying method=getConn prot=mysql remote_ip=%3A cost=0.22900390625 connect=0 read=0 write=0 trans=0 dbname=niux_yunying sql= err_no=10007 err_info=Connect+to+Mysql%28fengzongbao%40%3A-niux_yunying%29+failed extra=32213]&#10;WARNING: 11-23 17:11:30:  ral-worker * 32072 [php_ral.cpp:1022][logid=690103304 worker_id=32213 optime=1479892290.111370 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=nuomi_yunying method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=nuomi_yunying sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 11-23 17:11:35:  ral-worker * 32072 [ext/standard/protocol/nshead.cpp:68][logid=695822546 worker_id=32216 optime=1479892295.945720 caller=RAL idc=sh uniqid=2276560565 concurrency=1 request_name= service=starmap retry=0/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=-1.000 talk=-1.000 connect=23.162 write=0.039 read=-1.000 pack=0.191 unpack=-1.000 err_no=-1 msg=NsheadProtocol+read+header+failed prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE]&#10;WARNING: 11-23 17:11:35:  ral-worker * 32072 [rpc.cpp:295][logid=695822546 worker_id=32216 optime=1479892295.945803 log_type=E_TALK product=odp subsys=newapp module=oam user_ip= local_ip=10.99.19.36 caller=RAL idc=sh uniqid=2276560565 concurrency=1 request_name= service=starmap retry=0/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=-1.000 talk=46.565 connect=23.162 write=0.039 read=23.340 pack=0.191 unpack=-1.000 err_no=8 err_info=Talk+To+Server+Failed]&#10;WARNING: 11-23 17:11:35:  ral-worker * 32072 [ext/standard/protocol/nshead.cpp:68][logid=695822546 worker_id=32216 optime=1479892295.992290 caller=RAL idc=sh uniqid=847896472 concurrency=1 request_name= service=starmap retry=1/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=-1.000 talk=46.565 connect=23.142 write=0.012 read=23.340 pack=0.191 unpack=-1.000 err_no=-1 msg=NsheadProtocol+read+header+failed prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE]&#10;WARNING: 11-23 17:11:35:  ral-worker * 32072 [rpc.cpp:295][logid=695822546 worker_id=32216 optime=1479892295.992359 log_type=E_TALK product=odp subsys=newapp module=oam user_ip= local_ip=10.99.19.36 caller=RAL idc=sh uniqid=847896472 concurrency=1 request_name= service=starmap retry=1/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=-1.000 talk=46.492 connect=23.142 write=0.012 read=23.327 pack=0.191 unpack=-1.000 err_no=8 err_info=Talk+To+Server+Failed]&#10;WARNING: 11-23 17:11:36:  ral-worker * 32072 [ext/standard/protocol/nshead.cpp:68][logid=695822546 worker_id=32216 optime=1479892296.038646 caller=RAL idc=sh uniqid=3921071287 concurrency=1 request_name= service=starmap retry=2/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=-1.000 talk=46.492 connect=23.070 write=0.016 read=23.327 pack=0.191 unpack=-1.000 err_no=-1 msg=NsheadProtocol+read+header+failed prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE]&#10;WARNING: 11-23 17:11:36:  ral-worker * 32072 [rpc.cpp:295][logid=695822546 worker_id=32216 optime=1479892296.038734 log_type=E_TALK product=odp subsys=newapp module=oam user_ip= local_ip=10.99.19.36 caller=RAL idc=sh uniqid=3921071287 concurrency=1 request_name= service=starmap retry=2/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=-1.000 talk=46.321 connect=23.070 write=0.016 read=23.221 pack=0.191 unpack=-1.000 err_no=8 err_info=Talk+To+Server+Failed]&#10;WARNING: 11-23 17:11:36:  ral-worker * 32072 [rpc.cpp:242][logid=695822546 worker_id=32216 optime=1479892296.038781 log_type=E_SUM product=odp subsys=newapp module=oam user_ip= local_ip=10.99.19.36 caller=RAL idc=sh uniqid=3921071287 concurrency=1 request_name= service=starmap retry=2/2 is_connect_retry=0 method=nshead conv=mcpack2 prot=nshead remote_ip=10.202.23.46:8000 interface= prot_code=-7 prot_info=NSHEAD_RET_PEARCLOSE req_len=157 res_len=0 cost=139.766 talk=46.321 connect=23.070 write=0.016 read=23.221 pack=0.191 unpack=-1.000 err_no=8 err_info=Talk+To+Server+Failed]</span><br></pre></td></tr></table></figure></p>
<h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>与其他语言相比，<code>awk</code>数据驱动型语言。简单描述为，你可以在找到数据之后，可以按自定义的处理格式处理。</p>
<h4 id="基本列输出"><a href="#基本列输出" class="headerlink" title="基本列输出"></a>基本列输出</h4><p>按列格式化输出：</p>
<figure class="highlight bash"><figcaption><span>输出指定列</span></figcaption><table><tr><td class="code"><pre><span class="line">$ tail ral-worker.log | awk <span class="string">'&#123;print $16&#125;'</span></span><br><span class="line"><span class="built_in">caller</span>=RAL</span><br><span class="line">server=<span class="number">10.36</span>.<span class="number">55.25</span></span><br><span class="line">server=<span class="number">10.36</span>.<span class="number">55.25</span></span><br><span class="line">server=<span class="number">10.36</span>.<span class="number">55.25</span></span><br><span class="line">server=<span class="number">10.36</span>.<span class="number">55.25</span></span><br><span class="line"><span class="built_in">caller</span>=RAL</span><br></pre></td></tr></table></figure>
<h4 id="过滤输出"><a href="#过滤输出" class="headerlink" title="过滤输出"></a>过滤输出</h4><figure class="highlight bash"><figcaption><span>只输出错误码不为0的日志</span></figcaption><table><tr><td class="code"><pre><span class="line">$ tail ral-worker.log.wf | awk <span class="string">'$11 !="errno=0"'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341719911 worker_id=3677 optime=1502081741.767087 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341723082 worker_id=3679 optime=1502081741.771120 msg=ral_write_log log_type=E_SUM caller=Bd_DB from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=nuomi_mkt method=connect prot=mysql remote_ip=127.0.0.1%3A3306 cost=0 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=1049 err_info=Unknown+database+%27nuomi_mkt%27]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341723082 worker_id=3679 optime=1502081741.771381 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip=127.0.0.1%3A3306 cost=1.343994140625 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=10007 err_info=Connect+to+Mysql%28root%40127.0.0.1%3A3306-nuomi_mkt%29+failed extra=3679]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341723082 worker_id=3679 optime=1502081741.771450 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341718449 worker_id=3675 optime=1502081741.775986 msg=ral_write_log log_type=E_SUM caller=Bd_DB from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=nuomi_mkt method=connect prot=mysql remote_ip=127.0.0.1%3A3306 cost=0 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=1049 err_info=Unknown+database+%27nuomi_mkt%27]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341718449 worker_id=3675 optime=1502081741.776250 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip=127.0.0.1%3A3306 cost=1.2578125 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=10007 err_info=Connect+to+Mysql%28root%40127.0.0.1%3A3306-nuomi_mkt%29+failed extra=3675]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341718449 worker_id=3675 optime=1502081741.776308 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341763357 worker_id=3681 optime=1502081741.776867 msg=ral_write_log log_type=E_SUM caller=Bd_DB from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=nuomi_mkt method=connect prot=mysql remote_ip=127.0.0.1%3A3306 cost=0 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=1049 err_info=Unknown+database+%27nuomi_mkt%27]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341763357 worker_id=3681 optime=1502081741.777114 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip=127.0.0.1%3A3306 cost=1.281005859375 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=10007 err_info=Connect+to+Mysql%28root%40127.0.0.1%3A3306-nuomi_mkt%29+failed extra=3681]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341763357 worker_id=3681 optime=1502081741.777185 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]</span><br></pre></td></tr></table></figure>
<p>其中的“!=”为比较运算符。其他比较运算符：==, &gt;, &lt;, &gt;=, &lt;=</p>
<figure class="highlight bash"><figcaption><span>只输出log_type=E_WARN的日志</span></figcaption><table><tr><td class="code"><pre><span class="line">tail ral-worker.log.wf | awk <span class="string">'$11 =="log_type=E_WARN"'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341719911 worker_id=3677 optime=1502081741.767087 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341723082 worker_id=3679 optime=1502081741.771381 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip=127.0.0.1%3A3306 cost=1.343994140625 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=10007 err_info=Connect+to+Mysql%28root%40127.0.0.1%3A3306-nuomi_mkt%29+failed extra=3679]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341723082 worker_id=3679 optime=1502081741.771450 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341718449 worker_id=3675 optime=1502081741.776250 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip=127.0.0.1%3A3306 cost=1.2578125 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=10007 err_info=Connect+to+Mysql%28root%40127.0.0.1%3A3306-nuomi_mkt%29+failed extra=3675]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341718449 worker_id=3675 optime=1502081741.776308 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341763357 worker_id=3681 optime=1502081741.777114 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip=127.0.0.1%3A3306 cost=1.281005859375 connect=0 read=0 write=0 trans=0 dbname=nuomi_mkt sql= err_no=10007 err_info=Connect+to+Mysql%28root%40127.0.0.1%3A3306-nuomi_mkt%29+failed extra=3681]&#10;WARNING: 08-07 12:55:41:  ral-worker * 3572 [php_ral.cpp:1022][logid=3341763357 worker_id=3681 optime=1502081741.777185 msg=ral_write_log log_type=E_WARN caller=ConnMgr from=/home/users/fengzongbao/odp_market/php/phplib/bd/db/RALLog.php:100 service=oam_mis method=getConn prot=mysql remote_ip= cost=0 connect=0 read=0 write=0 trans=0 dbname=oam_mis sql= err_no=10006 err_info=No+host+could+be+connected+in+the+cluster]</span><br></pre></td></tr></table></figure>
<h3 id="内部变量"><a href="#内部变量" class="headerlink" title="内部变量"></a>内部变量</h3><p>说到了内建变量，我们可以来看看awk的一些内建变量：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$0</td>
<td>当前记录（这个变量中存放着整个行的内容）</td>
</tr>
<tr>
<td style="text-align:center"><code>$1~$n</code></td>
<td>当前记录的第n个字段，字段间由FS分隔</td>
</tr>
<tr>
<td style="text-align:center">FS</td>
<td>输入字段分隔符 默认是空格或Tab</td>
</tr>
<tr>
<td style="text-align:center">NF</td>
<td>当前记录中的字段个数，就是有多少列</td>
</tr>
<tr>
<td style="text-align:center">NR</td>
<td>已经读出的记录数，就是行号，从1开始，如果有多个文件话，这个值也是不断累加中</td>
</tr>
<tr>
<td style="text-align:center">FNR</td>
<td>当前记录数，与NR不同的是，这个值会是各个文件自己的行号</td>
</tr>
<tr>
<td style="text-align:center">RS</td>
<td>输入的记录分隔符， 默认为换行符</td>
</tr>
<tr>
<td style="text-align:center">OFS</td>
<td>输出字段分隔符， 默认也是空格</td>
</tr>
<tr>
<td style="text-align:center">ORS</td>
<td>输出的记录分隔符，默认为换行符</td>
</tr>
<tr>
<td style="text-align:center">FILENAME</td>
<td>当前输入文件的名字</td>
</tr>
</tbody>
</table>
<p>输出行号：</p>
<figure class="highlight bash"><figcaption><span>只输出log_type=E_WARN的日志</span></figcaption><table><tr><td class="code"><pre><span class="line">tail ral-worker.log.wf | awk <span class="string">'$11 =="log_type=E_WARN" &#123;printf "%02s %s %s %s\n",NR, FNR, $11, $16&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> 1 1 log_type=E_WARN prot=mysql&#10; 3 3 log_type=E_WARN prot=mysql&#10; 4 4 log_type=E_WARN prot=mysql&#10; 6 6 log_type=E_WARN prot=mysql&#10; 7 7 log_type=E_WARN prot=mysql&#10; 9 9 log_type=E_WARN prot=mysql&#10;10 10 log_type=E_WARN prot=mysql</span><br></pre></td></tr></table></figure>
<h4 id="自定义输出间隔"><a href="#自定义输出间隔" class="headerlink" title="自定义输出间隔"></a>自定义输出间隔</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ awk  <span class="string">'BEGIN&#123;FS=":"&#125; &#123;print $1,$3,$6&#125;'</span> /etc/passwd</span><br><span class="line">root <span class="number">0</span> /root</span><br><span class="line">daemon <span class="number">1</span> /usr/sbin</span><br><span class="line">bin <span class="number">2</span> /bin</span><br><span class="line">sys <span class="number">3</span> /dev</span><br><span class="line">sync <span class="number">4</span> /bin</span><br><span class="line">games <span class="number">5</span> /usr/games</span><br><span class="line">man <span class="number">6</span> /var/cache/man</span><br><span class="line">lp <span class="number">7</span> /var/spool/lpd</span><br></pre></td></tr></table></figure>
<p>上面的命令也等价于：（-F的意思就是指定分隔符）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ awk  -F: <span class="string">'&#123;print $1,$3,$6&#125;'</span> /etc/passwd</span><br></pre></td></tr></table></figure></p>
<p>以\t作为分隔符输出的例子（下面使用了/etc/passwd文件，这个文件是以:分隔的）：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ awk  -F: <span class="string">'&#123;print $1,$3,$6&#125;'</span> OFS=<span class="string">"\t"</span> /etc/passwd</span><br><span class="line">root    <span class="number">0</span>   /root</span><br><span class="line">daemon  <span class="number">1</span>   /usr/sbin</span><br><span class="line">bin <span class="number">2</span>   /bin</span><br><span class="line">sys <span class="number">3</span>   /dev</span><br><span class="line">sync    <span class="number">4</span>   /bin</span><br><span class="line">games   <span class="number">5</span>   /usr/games</span><br><span class="line">man <span class="number">6</span>   /var/cache/man</span><br><span class="line">lp  <span class="number">7</span>   /var/spool/lpd</span><br></pre></td></tr></table></figure></p>
<h4 id="字符串匹配"><a href="#字符串匹配" class="headerlink" title="字符串匹配"></a>字符串匹配</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">'$33 ~ /server/'</span> OFS=<span class="string">"\t"</span> ral-worker.log</span><br><span class="line">NOTICE: <span class="number">08</span>-<span class="number">02</span> <span class="number">16</span>:<span class="number">39</span>:<span class="number">05</span>:  ral-worker * <span class="number">20809</span> [rpc.cpp:<span class="number">240</span>][logid=<span class="number">2344882345</span> worker_id=<span class="number">20813</span> optime=<span class="number">1501663145.026209</span> <span class="built_in">log</span>_<span class="built_in">type</span>=E_SUM product=odp subsys=newapp module=engine user_ip= <span class="built_in">local</span>_ip=<span class="number">10.145</span>.<span class="number">81.150</span> <span class="built_in">caller</span>=RAL idc=sh uniqid=<span class="number">233576612</span> concurrency=<span class="number">1</span> request_name=<span class="number">0</span> service=galaxy_goods retry=<span class="number">0</span>/<span class="number">1</span> is_connect_retry=<span class="number">0</span> method=POST conv=form prot=http remote_ip=<span class="number">10.202</span>.<span class="number">6.208</span>:<span class="number">80</span> interface= prot_code=<span class="number">200</span> prot_info= curl_code=<span class="number">0</span> curl_errmsg= uri=nop/server/rest req_len=<span class="number">159</span> res_len=<span class="number">644</span> cost=<span class="number">64.226</span> talk=<span class="number">64.043</span> connect=<span class="number">26.894</span> write=<span class="number">0.000</span> <span class="built_in">read</span>=<span class="number">63.972</span> pack=<span class="number">0.017</span> unpack=<span class="number">0.004</span> err_no=<span class="number">0</span>]</span><br><span class="line">NOTICE: <span class="number">08</span>-<span class="number">03</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">13</span>:  ral-worker * <span class="number">3572</span> [rpc.cpp:<span class="number">240</span>][logid=<span class="number">3193817764</span> worker_id=<span class="number">3585</span> optime=<span class="number">1501768393.920692</span> <span class="built_in">log</span>_<span class="built_in">type</span>=E_SUM product=odp subsys=newapp module=engine user_ip= <span class="built_in">local</span>_ip=<span class="number">10.145</span>.<span class="number">81.150</span> <span class="built_in">caller</span>=RAL idc=sh uniqid=<span class="number">2655659683</span> concurrency=<span class="number">1</span> request_name=<span class="number">0</span> service=galaxy_goods retry=<span class="number">0</span>/<span class="number">1</span> is_connect_retry=<span class="number">0</span> method=POST conv=form prot=http remote_ip=<span class="number">10.202</span>.<span class="number">6.208</span>:<span class="number">80</span> interface= prot_code=<span class="number">200</span> prot_info= curl_code=<span class="number">0</span> curl_errmsg= uri=nop/server/rest req_len=<span class="number">159</span> res_len=<span class="number">644</span> cost=<span class="number">67.672</span> talk=<span class="number">64.092</span> connect=<span class="number">27.456</span> write=<span class="number">0.000</span> <span class="built_in">read</span>=<span class="number">64.015</span> pack=<span class="number">0.013</span> unpack=<span class="number">0.005</span> err_no=<span class="number">0</span>]</span><br><span class="line">NOTICE: <span class="number">08</span>-<span class="number">04</span> <span class="number">11</span>:<span class="number">34</span>:<span class="number">25</span>:  ral-worker * <span class="number">3572</span> [rpc.cpp:<span class="number">240</span>][logid=<span class="number">2065673224</span> worker_id=<span class="number">3590</span> optime=<span class="number">1501817665.763168</span> <span class="built_in">log</span>_<span class="built_in">type</span>=E_SUM product=odp subsys=newapp module=engine user_ip= <span class="built_in">local</span>_ip=<span class="number">10.145</span>.<span class="number">81.150</span> <span class="built_in">caller</span>=RAL idc=sh uniqid=<span class="number">3920350387</span> concurrency=<span class="number">1</span> request_name=<span class="number">0</span> service=galaxy_goods retry=<span class="number">0</span>/<span class="number">1</span> is_connect_retry=<span class="number">0</span> method=POST conv=form prot=http remote_ip=<span class="number">10.202</span>.<span class="number">6.208</span>:<span class="number">80</span> interface= prot_code=<span class="number">200</span> prot_info= curl_code=<span class="number">0</span> curl_errmsg= uri=nop/server/rest req_len=<span class="number">159</span> res_len=<span class="number">644</span> cost=<span class="number">64.657</span> talk=<span class="number">64.602</span> connect=<span class="number">26.746</span> write=<span class="number">0.000</span> <span class="built_in">read</span>=<span class="number">64.528</span> pack=<span class="number">0.013</span> unpack=<span class="number">0.003</span> err_no=<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>示例匹配uri包含<code>server</code>的请求。其实 ~ 表示模式开始。//中是模式。这就是一个正则表达式的匹配。</p>
<p>也可以是用<code>~ /server| galaxy/&#39;</code>表示“或者的关系”。</p>
<h4 id="文件拆分"><a href="#文件拆分" class="headerlink" title="文件拆分"></a>文件拆分</h4><p>awk拆分文件很简单，使用重定向即可。<br>下面这个例子，是按第6例分隔文件，相当的简单（其中的NR!=1表示不处理表头）。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ netstat | head -n <span class="number">10</span> | awk <span class="string">'NR!=1&#123;print &gt; $6&#125;'</span></span><br><span class="line">$ ls <span class="operator">-l</span></span><br><span class="line">total <span class="number">16</span></span><br><span class="line">-rw-rw-r-- <span class="number">1</span> fengzongbao fengzongbao  <span class="number">80</span> Aug <span class="number">10</span> <span class="number">17</span>:<span class="number">55</span> CLOSE_WAIT</span><br><span class="line">-rw-rw-r-- <span class="number">1</span> fengzongbao fengzongbao <span class="number">240</span> Aug <span class="number">10</span> <span class="number">17</span>:<span class="number">55</span> ESTABLISHED</span><br><span class="line">-rw-rw-r-- <span class="number">1</span> fengzongbao fengzongbao  <span class="number">80</span> Aug <span class="number">10</span> <span class="number">17</span>:<span class="number">55</span> Foreign</span><br><span class="line">-rw-rw-r-- <span class="number">1</span> fengzongbao fengzongbao <span class="number">320</span> Aug <span class="number">10</span> <span class="number">17</span>:<span class="number">55</span> TIME_WAIT</span><br></pre></td></tr></table></figure></p>
<h4 id="统计"><a href="#统计" class="headerlink" title="统计"></a>统计</h4><p>下面的命令计算所有的C文件，CPP文件和H文件的文件大小总和。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls <span class="operator">-l</span>  *.php | awk <span class="string">'&#123;sum+=$5&#125; END &#123;print sum&#125;'</span></span><br><span class="line"><span class="number">1320</span></span><br></pre></td></tr></table></figure></p>
<p>查看客户端连接：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ netstat -ntu | awk <span class="string">'&#123;print $5&#125;'</span> | cut <span class="operator">-d</span>: <span class="operator">-f</span>1 | sort | uniq -c | sort -nr</span><br><span class="line">     <span class="number">40</span> <span class="number">10.212</span>.<span class="number">15.235</span></span><br><span class="line">     <span class="number">31</span> <span class="number">10.207</span>.<span class="number">6.125</span></span><br><span class="line">     <span class="number">11</span> <span class="number">10.145</span>.<span class="number">81.150</span></span><br><span class="line">     <span class="number">10</span> <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">      <span class="number">3</span> <span class="number">10.128</span>.<span class="number">246.28</span></span><br><span class="line">      <span class="number">2</span> <span class="number">10.107</span>.<span class="number">65.36</span></span><br><span class="line">      <span class="number">1</span> servers)</span><br></pre></td></tr></table></figure></p>
<p>统计每个客户端对应的请求次数：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">awk <span class="string">'&#123;a[$1]++;&#125; END &#123;for (i in a) print i "," a[i]&#125;'</span> access_<span class="built_in">log</span></span><br><span class="line"><span class="number">172.20</span>.<span class="number">204.129</span>,<span class="number">206</span></span><br><span class="line"><span class="number">172.22</span>.<span class="number">152.101</span>,<span class="number">1</span></span><br><span class="line"><span class="number">172.22</span>.<span class="number">152.103</span>,<span class="number">1533</span></span><br><span class="line"><span class="number">172.20</span>.<span class="number">204.37</span>,<span class="number">5</span></span><br><span class="line"><span class="number">172.22</span>.<span class="number">152.105</span>,<span class="number">281</span></span><br><span class="line"><span class="number">172.22</span>.<span class="number">145.28</span>,<span class="number">2</span></span><br><span class="line"><span class="number">172.20</span>.<span class="number">204.149</span>,<span class="number">247</span></span><br></pre></td></tr></table></figure></p>
<p>每个用户的进程的占了多少内存：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps aux | awk <span class="string">'NR!=1&#123;a[$1]+=$6;&#125; END &#123; for(i in a) print i ", " a[i]"KB";&#125;'</span></span><br><span class="line">message+, <span class="number">1488</span>KB</span><br><span class="line">whoopsie, <span class="number">4596</span>KB</span><br><span class="line">syslog, <span class="number">6368</span>KB</span><br><span class="line">www-data, <span class="number">4758136</span>KB</span><br><span class="line"><span class="number">99</span>, <span class="number">16288</span>KB</span><br><span class="line">mysql, <span class="number">117776</span>KB</span><br><span class="line">ntp, <span class="number">1956</span>KB</span><br><span class="line">postfix, <span class="number">2992</span>KB</span><br><span class="line">root, <span class="number">673420</span>KB</span><br><span class="line">fengzon+, <span class="number">4604</span>KB</span><br></pre></td></tr></table></figure></p>
<h4 id="awk脚本"><a href="#awk脚本" class="headerlink" title="awk脚本"></a>awk脚本</h4><p>在上面我们可以看到一个END关键字。END的意思是“处理完所有的行的标识”，即然说到了END就有必要介绍一下BEGIN，这两个关键字意味着执行前和执行后的意思，语法如下：</p>
<ul>
<li>BEGIN{ 这里面放的是执行前的语句 }</li>
<li>END {这里面放的是处理完所有的行后要执行的语句 }</li>
<li>{这里面放的是处理每一行时要执行的语句}</li>
</ul>
<p>假设有这么一个文件（学生成绩表）：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat score.txt</span><br><span class="line">Marry   <span class="number">2143</span> <span class="number">78</span> <span class="number">84</span> <span class="number">77</span></span><br><span class="line">Jack    <span class="number">2321</span> <span class="number">66</span> <span class="number">78</span> <span class="number">45</span></span><br><span class="line">Tom     <span class="number">2122</span> <span class="number">48</span> <span class="number">77</span> <span class="number">71</span></span><br><span class="line">Mike    <span class="number">2537</span> <span class="number">87</span> <span class="number">97</span> <span class="number">95</span></span><br><span class="line">Bob     <span class="number">2415</span> <span class="number">40</span> <span class="number">57</span> <span class="number">62</span></span><br></pre></td></tr></table></figure></p>
<p>我们的awk脚本如下（我没有写有命令行上是因为命令行上不易读，另外也在介绍另一种用法）：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat cal.awk</span><br><span class="line"><span class="comment">#!/bin/awk -f</span></span><br><span class="line"><span class="comment">#运行前</span></span><br><span class="line">BEGIN &#123;</span><br><span class="line">    math = <span class="number">0</span></span><br><span class="line">    english = <span class="number">0</span></span><br><span class="line">    computer = <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL\n"</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"---------------------------------------------\n"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#运行中</span></span><br><span class="line">&#123;</span><br><span class="line">    math+=<span class="variable">$3</span></span><br><span class="line">    english+=<span class="variable">$4</span></span><br><span class="line">    computer+=<span class="variable">$5</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"%-6s %-6s %4d %8d %8d %8d\n"</span>, <span class="variable">$1</span>, <span class="variable">$2</span>, <span class="variable">$3</span>,<span class="variable">$4</span>,<span class="variable">$5</span>, <span class="variable">$3</span>+<span class="variable">$4</span>+<span class="variable">$5</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#运行后</span></span><br><span class="line">END &#123;</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"---------------------------------------------\n"</span></span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"  TOTAL:%10d %8d %8d \n"</span>, math, english, computer</span><br><span class="line">    <span class="built_in">printf</span> <span class="string">"AVERAGE:%10.2f %8.2f %8.2f\n"</span>, math/NR, english/NR, computer/NR</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们来看一下执行结果：（也可以这样运行 ./cal.awk score.txt）<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ awk <span class="operator">-f</span> cal.awk score.txt</span><br><span class="line">NAME    NO.   MATH  ENGLISH  COMPUTER   TOTAL</span><br><span class="line">---------------------------------------------</span><br><span class="line">Marry  <span class="number">2143</span>     <span class="number">78</span>       <span class="number">84</span>       <span class="number">77</span>      <span class="number">239</span></span><br><span class="line">Jack   <span class="number">2321</span>     <span class="number">66</span>       <span class="number">78</span>       <span class="number">45</span>      <span class="number">189</span></span><br><span class="line">Tom    <span class="number">2122</span>     <span class="number">48</span>       <span class="number">77</span>       <span class="number">71</span>      <span class="number">196</span></span><br><span class="line">Mike   <span class="number">2537</span>     <span class="number">87</span>       <span class="number">97</span>       <span class="number">95</span>      <span class="number">279</span></span><br><span class="line">Bob    <span class="number">2415</span>     <span class="number">40</span>       <span class="number">57</span>       <span class="number">62</span>      <span class="number">159</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">  TOTAL:       <span class="number">319</span>      <span class="number">393</span>      <span class="number">350</span></span><br><span class="line">AVERAGE:     <span class="number">63.80</span>    <span class="number">78.60</span>    <span class="number">70.00</span></span><br></pre></td></tr></table></figure></p>
<h4 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h4><p><code>akw</code>与环境变量的交互：（使用-v参数和ENVIRON，使用ENVIRON的环境变量需要export）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ x=<span class="number">5</span></span><br><span class="line"> </span><br><span class="line">$ y=<span class="number">10</span></span><br><span class="line">$ <span class="built_in">export</span> y</span><br><span class="line"> </span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$x</span> <span class="variable">$y</span></span><br><span class="line"><span class="number">5</span> <span class="number">10</span></span><br><span class="line"> </span><br><span class="line">$ awk -v val=<span class="variable">$x</span> <span class="string">'&#123;print $1, $2, $3, $4+val, $5+ENVIRON["y"]&#125;'</span> OFS=<span class="string">"\t"</span> score.txt</span><br><span class="line">Marry   <span class="number">2143</span>    <span class="number">78</span>      <span class="number">89</span>      <span class="number">87</span></span><br><span class="line">Jack    <span class="number">2321</span>    <span class="number">66</span>      <span class="number">83</span>      <span class="number">55</span></span><br><span class="line">Tom     <span class="number">2122</span>    <span class="number">48</span>      <span class="number">82</span>      <span class="number">81</span></span><br><span class="line">Mike    <span class="number">2537</span>    <span class="number">87</span>      <span class="number">102</span>     <span class="number">105</span></span><br><span class="line">Bob     <span class="number">2415</span>    <span class="number">40</span>      <span class="number">62</span>      <span class="number">72</span></span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="https://www.gnu.org/software/gawk/manual/gawk.html#Getting-Started" target="_blank" rel="external">The awk Language </a></li>
<li><a href="http://coolshell.cn/articles/9070.html" target="_blank" rel="external">AWK 简明教程</a></li>
</ul>


<!--<a href="http://yoursite.com/2016-9-27-awk-in-action.html#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mickeyouyou'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->






</body>
</html>