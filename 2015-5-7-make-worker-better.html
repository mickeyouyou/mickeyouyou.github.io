<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    
    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">
    <link href="http://download.easyicon.net/ico/1097218/24/" rel="shortcut icon" type="image/x-icon"/>

    
    <title>队列处理的一次优化实践 (Yaf Worker Manager)</title>
</head>

<body>

<h4 id="队列处理的一次优化实践－－让队列给我们带来更多性能提升(Yaf_Worker_Manager)">队列处理的一次优化实践－－让队列给我们带来更多性能提升(Yaf Worker Manager)</h4><p>先上出队列的worker性能测试结果：</p>
<p><img src="http://7tsys1.com1.z0.glb.clouddn.com/%E9%98%9F%E5%88%97%E5%A4%84%E7%90%86%E7%9F%AD%E4%BF%A1%E5%8F%91%E9%80%81%E6%B5%8B%E8%AF%95%E5%9B%BE.png" width="95%"></p>
<blockquote>
<p>powered by echarts.baidu.com</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">php进程数</th>
<th>job数量</th>
<th>处理time</th>
<th>效率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">1</td>
<td>5366 　</td>
<td>359sec</td>
<td>14 jobs/sec</td>
</tr>
<tr>
<td style="text-align:left">10</td>
<td>5366 　</td>
<td>45sec</td>
<td>119 jobs/sec</td>
</tr>
<tr>
<td style="text-align:left">50</td>
<td>5366</td>
<td>14sec</td>
<td>383 jobs/sec</td>
</tr>
</tbody>
</table>
<p>无论如何，此次<code>beanstalkd</code>消息队列带来的性能提升是非常明显的，要知道，在优化之前，短信应用的到达率很低很低，使用队列的结果就是很稳定，很高效，甚至是能取得皆大欢喜的结果，甚是欣喜。</p>
<h3 id="workermanager的一些优化">workermanager的一些优化</h3><p>接下来是对现有beanstalk　worker manager的一些改进，首先要说的是现在典阳所做的从<code>gearmanManager</code>扩展过来的workerManager已经非常优秀：</p>
<ul>
<li>基于适配器，可扩展支持其他（如：gearman）服务的的woker管理</li>
<li>详细的运行日志，快速定位问题</li>
<li>支持检测worker文件的变化，自动重启相应的worker进程（helper进程）</li>
<li>支持命令行、配置文件的方式启动worker</li>
<li>针对不同的处理任务可以启动一个或者多个处理进程</li>
<li>支持worker的最大生命周期，并自动重启</li>
<li>支持worker进程异常终止的自动重启</li>
<li>优雅的启动脚本</li>
</ul>
<p>yaf + worker manager 在编写的时候考虑到的因素：</p>
<ul>
<li>支持和yaf一样的不同环境切换配置文件</li>
<li>部署到线上不需要在需要修改配置文件再让一个个worker开始工作</li>
</ul>
<p>现有的配置情况是和beanstalk混合在一起的，在worker数量越来越多的情况下，还是有点混乱的：<br>beanstalkd.ini<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[WorkerManager]&#10;; beanstalkd servers&#10;host = 127.0.0.1:11300&#10;&#10;[WechatRefundQuery]&#10;; We are guaranteed 1 workers that can do job Paygw&#10;count = 0&#10;timeout = 5&#10;service=WechatRefundQuery&#10;&#10;[Sms]&#10;; We are guaranteed 1 workers that can do job Sms&#10;count = 10&#10;timeout = 5&#10;service=Sms</span><br></pre></td></tr></table></figure></p>
<p>在现有的基础上，需要增加环境文件，也就是不同环境的应用文件，就像yaf的application.ini一样：<br>sms.ini<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[common]&#10;; We are guaranteed 1 workers that can do job Sms&#10;count = 1&#10;timeout = 5&#10;service=Sms&#10;&#10;[develop]&#10;; We are guaranteed 1 workers that can do job Sms&#10;count = 0&#10;timeout = 5&#10;service=Sms&#10;&#10;[qa]&#10;; We are guaranteed 1 workers that can do job Sms&#10;count = 0&#10;timeout = 5&#10;service=Sms&#10;&#10;[online]&#10;; We are guaranteed 1 workers that can do job Sms&#10;count = 10&#10;timeout = 5&#10;service=Sms</span><br></pre></td></tr></table></figure></p>
<p>在考虑这样的变化的时候，我们还需要考虑配置文件的加载顺序，谁先加载谁的问题，比如现有的想法，<br>如果worker在启动的时候就将配置文件加载了进来（包括beanstalkd和service），并且，在修改配置文件的情况下需要重启worker。（修改worker业务代码的情况是不需要重启worker的，因为她会自动检测新代码改动），<br>这样，worker必然加载在application 之前，也就是</p>
<p>这样的变化，需要在workerManager启动的时候将相应环境的队列服务配置文件都加载进来，之前在Application 中是bootstrap 来完成的，但是在这个地方，应该也不会有太大的困难，我们试着开个分支实现以下：</p>
<h3 id="配置文件">配置文件</h3><p>并且我发现，其实在配置文件中，还多写了和配置节名相同的service名称配置，其实这是不必须的。所以也可以下下刀子。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[develop]&#10;; We are guaranteed 1 workers that can do job Sms&#10;count = 0&#10;timeout = 5</span><br></pre></td></tr></table></figure></p>
<h3 id="命令行参数=&gt;配置文件">命令行参数=&gt;配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public funtion run($config = array())&#10;public funtion getopt($config = array())</span><br></pre></td></tr></table></figure>
<p>本函数中的参数$config即为命令行参数，这个文件现在是作为启动守护进程时的参数进行传递的，看这个情况，完全可以在这个位置就传递进去，然后和其他的配置文件合并。</p>
<p>当为run函数传递一个命令行的配置文件时，日志却打印不出来了</p>
<p><code>YafWorkerManager</code>for beanstalkd</p>
<p>抽象的WorkerＭanager和扩展的workerManager两个类文件其实在注册本地类库之后其实并没什么其他的作用，就像其他在global中的类库一样，所以还是非常可以考虑把他们移到global中去，另外一个需要这样做的原因是我们在worker的处理也只是对beanstalkd-worker-manager.php的操作。</p>
<blockquote>
<p>现在先实现能在本地中将worker加载出来的情况，如果可以的话，可以考虑将抽象的WorkerＭanager和扩展的workerManager两个类文件移到全局类库(yaf).</p>
</blockquote>
<h4 id="还有什么疑惑?">还有什么疑惑?</h4><p>同时需要考虑的其他问题有：一台机器上面实例化了两个相同的Yaf Application，这个时候会不会有影响。</p>
<p>最后，无论如何我们现在始终在应用的使用阶段，但是相信离自己的基础组件已经不远了。</p>
<p>echarts代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">option = &#123;&#10;    title : &#123;&#10;        text: &#39;&#38431;&#21015;&#22788;&#29702;&#30701;&#20449;&#21457;&#36865;&#27979;&#35797;&#22270;&#39;,&#10;      subtext: &#39;&#27178;&#36724;&#20026;&#36827;&#31243;&#25968;&#65292;job&#24635;&#25968;:5366&#39;&#10;    &#125;,&#10;    tooltip : &#123;&#10;        trigger: &#39;axis&#39;&#10;    &#125;,&#10;    legend: &#123;&#10;        data:[&#39;&#32791;&#26102;&#39;,&#39;&#25928;&#29575;&#39;]&#10;    &#125;,&#10;    toolbox: &#123;&#10;        show : true,&#10;        feature : &#123;&#10;            mark : &#123;show: true&#125;,&#10;            dataView : &#123;show: true, readOnly: false&#125;,&#10;            magicType : &#123;show: true, type: [&#39;line&#39;, &#39;bar&#39;]&#125;,&#10;            restore : &#123;show: true&#125;,&#10;            saveAsImage : &#123;show: true&#125;&#10;        &#125;&#10;    &#125;,&#10;    calculable : true,&#10;    xAxis : [&#10;        &#123;&#10;            type : &#39;category&#39;,&#10;            data : [&#39;1&#39;,&#39;10&#39;,&#39;50&#39;]&#10;        &#125;&#10;    ],&#10;    yAxis : [&#10;        &#123;&#10;            type : &#39;value&#39;&#10;        &#125;&#10;    ],&#10;    series : [&#10;        &#123;&#10;            name:&#39;&#32791;&#26102;&#39;,&#10;            type:&#39;bar&#39;,&#10;            data:[359, 45, 19],&#10;        &#125;,&#10;        &#123;&#10;            name:&#39;&#25928;&#29575;&#39;,&#10;            type:&#39;bar&#39;,&#10;            data:[14, 119, 383],&#10;        &#125;&#10;    ]&#10;&#125;;</span><br></pre></td></tr></table></figure></p>
<h4 id="参考，希望对你也有帮助：">参考，希望对你也有帮助：</h4><blockquote>
<p><a href="https://github.com/brianlmoon/GearmanManager" target="_blank" rel="external">https://github.com/brianlmoon/GearmanManager</a></p>
</blockquote>
<h4 id="最后">最后</h4><p>为了看今晚的欧冠半决赛巴萨对阵拜仁的比赛，彻夜编码也是拼了。。。</p>


<!--<a href="http://yoursite.com/2015-5-7-make-worker-better.html#disqus_thread" class="article-comment-link">Comments</a>-->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = mickeyouyou; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div>







</body>
</html>