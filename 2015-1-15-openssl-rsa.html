<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    
    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">
    <link href="http://download.easyicon.net/icns/1097218/48/" rel="shortcut icon" type="image/x-icon"/>

    
    <title>Openssl 生成rsa私钥、公钥和证书</title>
</head>

<body>

<h1 id="openssl_生成rsa私钥、公钥和证书">openssl 生成rsa私钥、公钥和证书</h1><h4 id="SSL">SSL</h4><p>SSL 是一个缩写，代表的是 Secure Sockets Layer。它是支持在 Internet 上进行安全通信的 标准，并且将数据密码术集成到了协议之中。数据在离开您的计算机之前就已经被加密，然后只有 到达它预定的目标后才被解密。证书和密码学算法支持了这一切的运转，使用 OpenSSL，您将 有机会切身体会它们。<br>理论上，如果加密的数据在到达目标之前被截取或窃听，那些数据是不可能被破解的。不过， 由于计算机的变化一年比一年快，而且密码翻译方法有了新的发展，因此，SSL 中使用的加密协议 被破解的可能性也在增大。<br>可以将 SSL 和安全连接用于 Internet 上任何类型的协议，不管是 HTTP、POP3，还是 FTP。还可以用 SSL 来保护 Telnet 会话。虽然可以用 SSL 保护任何连接，但是不必对每一类连接都使用 SSL。 如果连接传输敏感信息，则应使用 SSL。</p>
<h4 id="OpenSSL">OpenSSL</h4><p>OpenSSL 不仅仅是 SSL。它可以实现消息摘要、文件的加密和解密、数字证书、数字签名 和随机数字。关于 OpenSSL 库的内容非常多，远不是一篇文章可以容纳的。<br>OpenSSL 不只是 API，它还是一个命令行工具。命令行工具可以完成与 API 同样的工作， 而且更进一步，可以测试 SSL 服务器和客户机。它还让开发人员对 OpenSSL 的能力有一个 认识。要获得关于如何使用 OpenSSL 命令行工具的资料，请参阅 <a href="https://www.openssl.org/docs/apps/openssl.html" target="_blank" rel="external">官方手册</a>。</p>
<h4 id="openssl_的编译安装">openssl 的编译安装</h4><p>下载：<a href="https://www.openssl.org/source/" target="_blank" rel="external">https://www.openssl.org/source/</a></p>
<p>安装 OpenSSL, 请确保你已安装以下组件:</p>
<ul>
<li>make</li>
<li>Perl 5</li>
<li>an ANSI C compiler</li>
<li>a development environment in form of development libraries and C<br>header files</li>
<li>a supported Unix operating system</li>
</ul>
<h2 id="快速安装">快速安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./config&#10;$ make&#10;$ make test&#10;$ make install</span><br></pre></td></tr></table></figure>
<blockquote>
<p>更多的安装细节可以参考安装包中的INSTALL文件:<a href="https://github.com/openssl/openssl/blob/master/INSTALL" target="_blank" rel="external">https://github.com/openssl/openssl/blob/master/INSTALL</a></p>
</blockquote>
<h4 id="产生私钥">产生私钥</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  openssl</span><br><span class="line">OpenSSL&gt; genrsa -out rsa_private_key.pem <span class="number">1024</span>              </span><br><span class="line">Generating RSA private key, <span class="number">1024</span> bit long modulus</span><br><span class="line">..........++++++</span><br><span class="line">...++++++</span><br><span class="line">e is <span class="number">65537</span> (<span class="number">0</span>x10001)</span><br><span class="line">OpenSSL&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10140;  ~  vim rsa_private_key.pem &#10;----BEGIN RSA PRIVATE KEY-----&#10;MIICXQIBAAKBgQDLAwyua/Mhu4Ik8a2iLst0yWijyyDeHsuTEM9/X/IhAtlxHJ7w&#10;GmO5UmD0rSGv5rGDlu5n/jo8p35WLbOGTocs9RlOV5wS69rxtiO0CHHSdOi+jh1r&#10;+9mDiPmnQQ2sOl6KFsvGwRB3UaCc6LgqDqsg89/f4IkrLLas3nPRa989RQIDAQAB&#10;AoGALjLZde/2+lwzd7jP7LJ9dmxHNc8KAcI8TZFrxu7MqRp+5TDAMp+uxgOrMMMd&#10;gWwcRXfZdSzzj84GABKSYiQIupg7V6rk/XgmIQAiBjWEvyzpwp71IRE9dzhkL5Qc&#10;WF/PymajQ766vI1FhhLdU85Rc0Gly5ZawsfQGDBJ/s6AWMECQQD47D4gPA/Pnzpx&#10;5VnMJpgLLqA7E5oOBiD0EINUZ0iYPMu/EYazUTAcLoRitUQorm16aP7IjaUvymHA&#10;9HfDYsXpAkEA0MimPCuD3Pg8xaaSrqGXSCufOMezIOZcnFYSCIcAy0p0mBoySZON&#10;ypvjB8ojhvCONRhQFJy35OlFuAOsl162/QJBAMNYalzTpbjTBYOycGkU9Ib5/Ua/&#10;WEufJadDejz3nPHT7DUy5Nm+YhoLq1rnU+j1EfdZhHERL8w0b8iEUaRk1FkCQBEG&#10;S4fchIQgOdRkINHcm1lnNTSMFC86mZKl8hJ/77CkAZ3lhPQ68/TxgTHBaeQ2+WGa&#10;+ey0Wspvux+mLQyqzIECQQDEL+4/UFI/wKAsO41k8wibzZ8/Rm3BQTwV0i5tzxHO&#10;9N5jIHkZa5AIVhq2qNBD+ev8gNp9MbipYUhduHrudLdS&#10;-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>
<h4 id="产生公钥">产生公钥</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OpenSSL&gt; rsa -in rsa_private_key.pem -pubout -out rsa_public_key.pem</span><br><span class="line">writing RSA key</span><br><span class="line"></span><br><span class="line">➜  ~  vim rsa_public_key.pem </span><br><span class="line"></span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDLAwyua/Mhu4Ik8a2iLst0yWij</span><br><span class="line">yyDeHsuTEM9/X/IhAtlxHJ7wGmO5UmD0rSGv5rGDlu5n/jo8p35WLbOGTocs9RlO</span><br><span class="line">V5wS69rxtiO0CHHSdOi+jh1r+<span class="number">9</span>mDiPmnQQ2sOl6KFsvGwRB3UaCc6LgqDqsg89/f</span><br><span class="line"><span class="number">4</span>IkrLLas3nPRa989RQIDAQAB</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure>
<h4 id="生成证书">生成证书</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  ~  openssl req -new -key rsa_private_key.pem -out zongbao.csr</span><br><span class="line">You are about to be asked to enter information that will be incorporated</span><br><span class="line">into your certificate request.</span><br><span class="line">What you are about to enter is what is called a Distinguished Name or a DN.</span><br><span class="line">There are quite a few fields but you can leave some blank</span><br><span class="line">For some fields there will be a default value,</span><br><span class="line">If you enter <span class="string">'.'</span>, the field will be left blank.</span><br><span class="line">-----</span><br><span class="line">Country Name (<span class="number">2</span> letter code) [AU]:cn</span><br><span class="line">State or Province Name (full name) [Some-State]:beijing</span><br><span class="line">Locality Name (eg, city) []:bj</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:jinritemai</span><br><span class="line">Organizational Unit Name (eg, section) []:jrtm</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:fengzbao</span><br><span class="line">Email Address []:fengzbao@qq.com</span><br><span class="line"></span><br><span class="line">Please enter the following <span class="string">'extra'</span> attributes</span><br><span class="line">to be sent with your certificate request</span><br><span class="line">A challenge password []:<span class="number">1</span>q2w3e4r</span><br><span class="line">An optional company name []:jinritemai</span><br><span class="line">➜  ~</span><br></pre></td></tr></table></figure>
<h3 id="生成待签名的字符串">生成待签名的字符串</h3><p><strong>要参与签名的参数</strong><br>在请求参数列表中,除去 sign、sign_type 两个参数外,其他需要使用到的参数皆是要签名的参数。(个别接口中参数 sign_type 也需要参与签名。)在通知返回参数列表中,除去 sign、sign_type 两个参数外,凡是通知返回回来的参数皆是要签名的参数</p>
<p>根据支付宝的要求，数组需要完成以下重组：</p>
<blockquote>
<p>对数组里的每一个值从 a 到 z 的顺序排序,若遇到相同首字母,则看第二个字母,以此类推。排序完成之后,再把所有数组值以“&amp;”字符连接起来,<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">(<span class="variable">$data</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line"> <span class="variable">$array</span> = <span class="keyword">array</span> (</span><br><span class="line">     <span class="string">'out_trade_no'</span> =&gt; <span class="string">'15002420575997'</span>,</span><br><span class="line">     <span class="string">'trade_no'</span> =&gt; <span class="string">'2015012041879426'</span>,</span><br><span class="line">     <span class="string">'reason'</span> =&gt; <span class="string">'商品质量问题'</span>,</span><br><span class="line">     <span class="string">'trans_fee'</span> =&gt; <span class="string">'1000'</span>,</span><br><span class="line">     <span class="string">'payee_account'</span> =&gt; <span class="string">'fengzbao@qq.com'</span>,</span><br><span class="line">     <span class="string">'payee_name'</span> =&gt; <span class="string">'冯宗宝'</span>,</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line"> ksort(<span class="variable">$array</span>);</span><br><span class="line"> <span class="variable">$message</span> = <span class="string">''</span>;</span><br><span class="line"> <span class="keyword">foreach</span>(<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">     <span class="variable">$message</span> .= <span class="variable">$key</span>.<span class="string">"="</span>.<span class="variable">$value</span>.<span class="string">"&amp;"</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="variable">$message</span> = substr(<span class="variable">$message</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line"> <span class="variable">$pric_key_id</span> = openssl_get_privatekey(<span class="variable">$this</span>-&gt;private_key);</span><br><span class="line"></span><br><span class="line">    openssl_sign(<span class="variable">$this</span>-&gt;message, <span class="variable">$signgure</span>, <span class="variable">$pric_key_id</span>);</span><br><span class="line">    openssl_free_key(<span class="variable">$pric_key_id</span>);</span><br><span class="line"> </span><br><span class="line">&#125;    </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">(<span class="variable">$data</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">    <span class="variable">$sign</span> = <span class="variable">$data</span>[<span class="string">'tt_sign'</span>];</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="string">'tt_sign'</span>]);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="string">'tt_sign_type'</span>]);</span><br><span class="line">    ksort(<span class="variable">$data</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$message</span> = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="variable">$message</span> .= <span class="variable">$key</span> . <span class="string">'='</span> . <span class="variable">$value</span> . <span class="string">'&amp;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$message</span> = substr(<span class="variable">$message</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$publicKey</span> = ;</span><br><span class="line">    <span class="variable">$publicKeyId</span> = openssl_pkey_get_public(<span class="variable">$publicKey</span>);</span><br><span class="line">    <span class="variable">$result</span> = openssl_verify(<span class="variable">$message</span>, base64_decode(<span class="variable">$sign</span>), <span class="variable">$publicKeyId</span>);</span><br><span class="line">    openssl_free_key(<span class="variable">$publicKeyId</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意：</p>
<ul>
<li>没有值的参数无需传递,也无需包含到待签名数据中;</li>
<li>根据 HTTP 协议要求,传递参数的值中如果存在特殊字符(如:&amp;、@等),<br>那么该值需要做 URL Encoding,这样请求接收方才能接收到正确的参数值。这<br>种情况下,待签名数据应该是原生值而不是 encoding 之后的值。例如:调用某<br>接口需要对请求参数 email 进行数字签名,那么待签名数据应该是<br>email=test@msn.com,而不是 email=test%40msn.com。</li>
</ul>
</blockquote>
<h3 id="RSA签名">RSA签名</h3><p>在 DSA 或 RSA 的签名时,需要私钥和公钥一起参与签名。私钥与公钥皆是客户通过 OPENSSL 来生成得出的。客户把生成出的公钥与支付宝技术人员配置好的支付宝公钥做交换。因此,在签名时,客户要用到的是客户的私钥及支付宝的公钥。</p>
<h4 id="请求时签名">请求时签名</h4><p>当拿到请求时的待签名字符串后,把待签名字符串与客户的私钥一同放入 DSA 或RSA 的签名函数中进行签名运算,从而得到签名结果字符串。</p>
<h4 id="通知返回时验证签名">通知返回时验证签名</h4><p>当获得到通知返回时的待签名字符串后,把待签名字符串、支付宝提供的公钥、支付宝通知返回参数中的参数 sign 的值三者一同放入 DSA 或 RSA 的签名函数中进行非对称的签名运算,来判断签名是否验证通过。</p>
<h4 id="更多">更多</h4><p>本文只是在做支付过程中的一个指导文件，openssl还可以对文件生成信息摘要等，大家可以参考下面的两篇文章获取更多信息：</p>
<ul>
<li><a href="http://www.rising.com.cn/newsletter/news/2013-02-26/13227.html" target="_blank" rel="external">在Linux环境下使用OpenSSL对消息和文件进行加密</a></li>
<li><a href="http://blog.chinaunix.net/uid-26729093-id-4090311.html" target="_blank" rel="external">openssl使用手册</a></li>
</ul>


<!--<a href="http://yoursite.com/2015-1-15-openssl-rsa.html#disqus_thread" class="article-comment-link">Comments</a>-->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = mickeyouyou; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div>







</body>
</html>