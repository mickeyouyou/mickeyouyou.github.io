<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    
    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">
    <link href="http://download.easyicon.net/ico/1097219/24/" rel="shortcut icon" type="image/x-icon"/>

    
    <title>Grab in PHP</title>
</head>

<body>

<h1 id="Grab_in_PHP">Grab in PHP</h1><h4 id="前话">前话</h4><p>程序之间的交流用json之类数据交互格式，有API会给我们提供很方便的事情。最近在做空气质量数据统计的小东西的时候，碰到几个网站虽开放了API也是很小气的对每小时内的请求次数进行了限制，没意思,还是去从数据的源头入口搞搞看。</p>
<p><img src="http://7tsys1.com1.z0.glb.clouddn.com/Selection_028.png" width="90%"></p>
<h3 id="Tool">Tool</h3><p>其中不乏被成为利器的工具：</p>
<h4 id="Snoopy"><a href="https://github.com/endroy/Snoopy" target="_blank" rel="external">Snoopy</a></h4><p>Snoopy是一个用来模拟浏览器的功能，可以获取网页内容，发送表单，可以用来开发一些采集程序和小偷程序的类。</p>
<p>演示用例：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="string">"Snoopy.class.php"</span>;</span><br><span class="line">	<span class="variable">$snoopy</span> = <span class="keyword">new</span> Snoopy;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$snoopy</span>-&gt;fetchtext(<span class="string">"http://www.php.net/"</span>);</span><br><span class="line">	<span class="keyword">print</span> <span class="variable">$snoopy</span>-&gt;results;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$snoopy</span>-&gt;fetchlinks(<span class="string">"http://www.phpbuilder.com/"</span>);</span><br><span class="line">	<span class="keyword">print</span> <span class="variable">$snoopy</span>-&gt;results;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$submit_url</span> = <span class="string">"http://lnk.ispi.net/texis/scripts/msearch/netsearch.html"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$submit_vars</span>[<span class="string">"q"</span>] = <span class="string">"amiga"</span>;</span><br><span class="line">	<span class="variable">$submit_vars</span>[<span class="string">"submit"</span>] = <span class="string">"Search!"</span>;</span><br><span class="line">	<span class="variable">$submit_vars</span>[<span class="string">"searchhost"</span>] = <span class="string">"Altavista"</span>;</span><br><span class="line">		</span><br><span class="line">	<span class="variable">$snoopy</span>-&gt;submit(<span class="variable">$submit_url</span>,<span class="variable">$submit_vars</span>);</span><br><span class="line">	<span class="keyword">print</span> <span class="variable">$snoopy</span>-&gt;results;</span><br><span class="line">	</span><br><span class="line">	<span class="variable">$snoopy</span>-&gt;maxframes=<span class="number">5</span>;</span><br><span class="line">	<span class="variable">$snoopy</span>-&gt;fetch(<span class="string">"http://www.ispi.net/"</span>);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;PRE&gt;\n"</span>;</span><br><span class="line">	<span class="keyword">echo</span> htmlentities(<span class="variable">$snoopy</span>-&gt;results[<span class="number">0</span>]); </span><br><span class="line">	<span class="keyword">echo</span> htmlentities(<span class="variable">$snoopy</span>-&gt;results[<span class="number">1</span>]); </span><br><span class="line">	<span class="keyword">echo</span> htmlentities(<span class="variable">$snoopy</span>-&gt;results[<span class="number">2</span>]); </span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"&lt;/PRE&gt;\n"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="variable">$snoopy</span>-&gt;fetchform(<span class="string">"http://www.altavista.com"</span>);</span><br><span class="line">	<span class="keyword">print</span> <span class="variable">$snoopy</span>-&gt;results;</span><br></pre></td></tr></table></figure>
<p>但是我个人对这个工具还不是太钟爱，至少在解决页面数据抓取的问题上没有下面这个工具来的爽快。</p>
<h4 id="SimpleHtmlDom"><a href="http://simplehtmldom.sourceforge.net/manual.htm" target="_blank" rel="external">SimpleHtmlDom</a></h4><p>这个工具的名字就像他自己写的那样一样低调简单，能想jQuery那样对php获取到的内容选择、操作、替换、删除，只要能获取到相应的数据，还是非常利落的。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">&lt;?php</span></span><br><span class="line"><span class="comment">// 包含或引用</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'../simple_html_dom.php'</span>);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// file_get_html从URL或者html文件获取DOM</span></span><br><span class="line"><span class="variable">$html</span> = file_get_html(<span class="string">'http://www.google.com/'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找出所有a链接</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'a'</span>) <span class="keyword">as</span> <span class="variable">$e</span>) </span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;href . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取所有图像</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'img'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;src . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取img标签的全部内容</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'img'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;outertext . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到所有id=gbar的div标签</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'div#gbar'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;innertext . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到所有class=gb1的span标签</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'span.gb1'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;outertext . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 找到所有属性为align=center的td</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'td[align=center]'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$e</span>-&gt;innertext . <span class="string">'&lt;br&gt;'</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 从表格中获取值，比如获取&lt;td&gt;value&lt;/td&gt;中的value</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$html</span>-&gt;find(<span class="string">'td[align="center"]'</span>, <span class="number">1</span>)-&gt;plaintext.<span class="string">'&lt;br&gt;&lt;hr&gt;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 移除所有图像</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'img'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="variable">$e</span>-&gt;outertext = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 替换所有input</span></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'input'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)</span><br><span class="line">    <span class="variable">$e</span>-&gt;outertext = <span class="string">'[INPUT]'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从html中获取所有文本</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$html</span>-&gt;plaintext;</span><br><span class="line"><span class="preprocessor">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>注意</strong><br>本工具是显得非常简单易用，但是需要注意很容易引起内存泄露（Memory Leak）比如下面的调试情况：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$html</span> = file_get_html(<span class="string">"……"</span>);</span><br><span class="line">print_r(<span class="variable">$html</span>);</span><br><span class="line"><span class="variable">$html</span>-&gt;clear();</span><br><span class="line"><span class="keyword">unset</span>(<span class="variable">$html</span>);</span><br></pre></td></tr></table></figure></p>
<p>因为PHP5循环引用内存泄露，在创建DOM对象之后，你需要调用<code>$dom-&gt;clear()</code>以释放因为<code>file_get_dom()</code>多次调用的内存。</p>
<h3 id="steps">steps</h3><h4 id="1、获取环境空气质量标准城市列表">1、获取环境空气质量标准城市列表</h4><p><a href="http://www.pm25.in/api_doc" target="_blank" rel="external">PM25.IN</a> 提供了获取所有参与空气质量检测的城市，只需要调用其中的api就可以轻松获得一个json格式的cities。</p>
<h4 id="2、获取单个城市的空气质量数据">2、获取单个城市的空气质量数据</h4><p>比如我们获取链接：</p>
<blockquote>
<p><a href="http://aqistudy.sinaapp.com/historydata/monthdata.php?city=%E4%B8%8A%E6%B5%B7" target="_blank" rel="external">http://aqistudy.sinaapp.com/historydata/monthdata.php?city=%E4%B8%8A%E6%B5%B7</a></p>
</blockquote>
<p>中每个月份的AQI、范围、质量等级、PM2.5、PM10、SO2等数据，在载入simple_html_dom.php之后，就可以使用<code>file_get_html()</code>函数获取上面链接的内容，然后在对所有<code>td[align=center]</code>选择器中的数据进行提取，结果中可能有不符合条件的数据，你还需要去除不符合的部分，最后，为了让此json友好地可用，增加数组键名。<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 获取单个城市的空气质量数据</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> $city string 城市名称</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getOneCityAction</span><span class="params">(<span class="variable">$city</span>)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="variable">$html</span> = file_get_html(<span class="variable">$this</span>-&gt;url.<span class="variable">$city</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$array</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$html</span>-&gt;find(<span class="string">'td[align=center]'</span>) <span class="keyword">as</span> <span class="variable">$e</span>)&#123;</span><br><span class="line">		array_push(<span class="variable">$array</span>, <span class="variable">$e</span>-&gt;plaintext);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 清除掉末尾的6个</span></span><br><span class="line">	<span class="variable">$num</span> = count(<span class="variable">$array</span>);</span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$array</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$key</span> &lt; (<span class="variable">$num</span>-<span class="number">6</span>))&#123;</span><br><span class="line">			<span class="variable">$cleanData</span>[<span class="variable">$key</span>] = <span class="variable">$value</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 重新分组</span></span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$cleanData</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)&#123;</span><br><span class="line">		<span class="variable">$data</span>  = array_chunk(<span class="variable">$cleanData</span>, <span class="number">11</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 修改键名</span></span><br><span class="line">	<span class="keyword">foreach</span>(<span class="variable">$data</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$value</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="variable">$value</span> <span class="keyword">as</span> <span class="variable">$kk</span>=&gt;<span class="variable">$vv</span>) &#123;</span><br><span class="line">			<span class="keyword">switch</span> (<span class="variable">$kk</span>)&#123;</span><br><span class="line">				<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'month'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">0</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'AQI'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">1</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'range'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">2</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'quality'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">3</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'pm2.5'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">4</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'pm10'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">5</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'so2'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">6</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'co'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">7</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'no2'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">8</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">9</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'o3'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">9</span>]);</span><br><span class="line">				<span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">					<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="string">'rank'</span>] = <span class="variable">$vv</span>;</span><br><span class="line">					<span class="keyword">unset</span>(<span class="variable">$data</span>[<span class="variable">$key</span>][<span class="number">10</span>]);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 保存文件</span></span><br><span class="line">	<span class="variable">$this</span>-&gt;file-&gt;write(<span class="variable">$city</span>.<span class="string">'年度空气质量.json'</span>, json_encode(<span class="variable">$data</span>, JSON_UNESCAPED_UNICODE));</span><br><span class="line">	<span class="variable">$this</span>-&gt;log(<span class="string">'debug'</span>, var_export(<span class="variable">$data</span>, <span class="keyword">true</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="3、获取全部城市的空气质量数据">3、获取全部城市的空气质量数据</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * 获取所有城市的空气质量数据</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllAction</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(!\Yaf\Loader::import(<span class="string">"../../../install/simplehtmldom/simple_html_dom.php"</span>))&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">'SimpleHtmlDom.php文件没有正确加载进来'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">foreach</span>(json_decode(<span class="variable">$this</span>-&gt;cities) <span class="keyword">as</span> <span class="variable">$city</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">foreach</span>(<span class="variable">$city</span> <span class="keyword">as</span> <span class="variable">$cityname</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable">$this</span>-&gt;getOneCityAction(<span class="variable">$cityname</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Result">Result</h4><p><img src="http://7tsys1.com1.z0.glb.clouddn.com/Selection_027.png" width="90%"></p>


<!--<a href="http://yoursite.com/2015-1-26-grab-in-php.html#disqus_thread" class="article-comment-link">Comments</a>-->
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = mickeyouyou; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div>







</body>
</html>