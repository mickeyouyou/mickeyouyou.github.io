<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>Apollo 高精地图</title>
	<meta name="keywords" content="fzb.me,冯宗宝,冯宗宝的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>


<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 class="title">Apollo 高精地图</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2018年2月28日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#高精地图规范"><span class="toc-text"><a href="#&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x89C4;&#x8303;" class="headerlink" title="&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x89C4;&#x8303;"></a>&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x89C4;&#x8303;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#格式"><span class="toc-text"><a href="#&#x683C;&#x5F0F;" class="headerlink" title="&#x683C;&#x5F0F;"></a>&#x683C;&#x5F0F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#坐标"><span class="toc-text"><a href="#&#x5750;&#x6807;" class="headerlink" title="&#x5750;&#x6807;"></a>&#x5750;&#x6807;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#车道"><span class="toc-text"><a href="#&#x8F66;&#x9053;" class="headerlink" title="&#x8F66;&#x9053;"></a>&#x8F66;&#x9053;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路口区域（juction）"><span class="toc-text"><a href="#&#x8DEF;&#x53E3;&#x533A;&#x57DF;&#xFF08;juction&#xFF09;" class="headerlink" title="&#x8DEF;&#x53E3;&#x533A;&#x57DF;&#xFF08;juction&#xFF09;"></a>&#x8DEF;&#x53E3;&#x533A;&#x57DF;&#xFF08;juction&#xFF09;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高精地图的使用"><span class="toc-text"><a href="#&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x7684;&#x4F7F;&#x7528;" class="headerlink" title="&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x7684;&#x4F7F;&#x7528;"></a>&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x7684;&#x4F7F;&#x7528;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text"><a href="#&#x53C2;&#x8003;" class="headerlink" title="&#x53C2;&#x8003;"></a>&#x53C2;&#x8003;</span></a></li></ol>
<p>关于百度高精地图，开发者会提问很多关于制作、使用的问题。下面会基于目前Apollo开放的地图数据部分，讲解下高精地图的数据格式。</p>
<h2 id="高精地图规范"><a href="#高精地图规范" class="headerlink" title="高精地图规范"></a>高精地图规范</h2><h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p>百度高精地图数据格式采用（XML）文件格式的数据组织方式，是基于国际通用的OpenDrive规范，并根据百度自动驾驶业务需求拓展修改而成。</p>
<p>Apollo高精地图文件的整体结构如下所示：</p>
<div id="flowchart-0" class="flow-chart"></div>

<h3 id="坐标"><a href="#坐标" class="headerlink" title="坐标"></a>坐标</h3><p>百度高精地图坐标采用WGS84经纬度坐标表示。</p>
<h3 id="车道"><a href="#车道" class="headerlink" title="车道"></a>车道</h3><p><strong>道路的reference line 存储在ID为0的车道中，其他车道只存储当前车道的一个边界。例如，reference line右侧的车道只存储车道的右侧边界。</strong></p>
<p><img src="http://7tsys1.com1.z0.glb.clouddn.com/WechatIMG145.jpeg" width="99%"><br>车道 ID 的命名规则:</p>
<ul>
<li>lane section 内唯一</li>
<li>数值连续的</li>
<li>reference line 所在 lane 的 ID 为 0</li>
<li>reference line 左侧 lane 的 ID 向左侧依次递增 (正t轴方向) </li>
<li>reference line 右侧 lane 的 ID 向右侧依次递减(负 t 轴方向) </li>
<li>reference line 必须定义在<code>&lt;center&gt;</code>节点内</li>
</ul>
<p>车道总数目没有限制。Reference line 自身必须为 Lane 0。</p>
<h3 id="路口区域（juction）"><a href="#路口区域（juction）" class="headerlink" title="路口区域（juction）"></a>路口区域（juction）</h3><p>基本的原理比较简单，路口区域用junction结构表达。在Junction内，incoming Road通过Connecting Roads与out-going道路相连。下图展示了一个比较复杂的路口：</p>
<p><img src="http://7tsys1.com1.z0.glb.clouddn.com/WechatIMG146.jpeg" width="79%"></p>
<p>一段道路的相关高精度地图可以放置在如下结构的目录中：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;map_dir&gt;                        # Defined by FLAGS_map_dir</span><br><span class="line">  |-- base_map.xml               # Defined by FLAGS_base_map_filename</span><br><span class="line">  |-- routing_map.bin            # Defined by FLAGS_routing_map_filename</span><br><span class="line">  |-- sim_map.bin                # Defined by FLAGS_sim_map_filename</span><br><span class="line">  |-- default_end_way_point.txt  # Defined by FLAGS_end_way_point_filename</span><br></pre></td></tr></table></figure></p>
<p>可以将可用地图文件名指定为备选列表：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--base_map_filename=&quot;base.xml|base.bin|base.txt&quot;</span><br></pre></td></tr></table></figure></p>
<p>然后Apollo会找到第一个可用的文件加载。一般来说，我们遵循以下扩展模式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">x.xml  # An OpenDrive formatted map.</span><br><span class="line">x.bin  # A binary pb map.</span><br><span class="line">x.txt  # A text pb map.</span><br></pre></td></tr></table></figure>
<p>不管原始数据格式为什么，在Apollo内部的数据地图的格式为proto。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// This message defines how we project the ellipsoidal Earth surface to a plane.</span><br><span class="line">message Projection &#123;</span><br><span class="line">  // PROJ.4 setting:</span><br><span class="line">  // &quot;+proj=tmerc +lat_0=&#123;origin.lat&#125; +lon_0=&#123;origin.lon&#125; +k=&#123;scale_factor&#125; +ellps=WGS84 +no_defs&quot;</span><br><span class="line">  optional string proj = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Header &#123;</span><br><span class="line">  optional bytes version = 1;</span><br><span class="line">  optional bytes date = 2;</span><br><span class="line">  optional Projection projection = 3;//坐标系转换</span><br><span class="line">  optional bytes district = 4;</span><br><span class="line">  optional bytes generation = 5;</span><br><span class="line">  optional bytes rev_major = 6;</span><br><span class="line">  optional bytes rev_minor = 7;</span><br><span class="line">  optional double left = 8;</span><br><span class="line">  optional double top = 9;</span><br><span class="line">  optional double right = 10;</span><br><span class="line">  optional double bottom = 11;</span><br><span class="line">  optional bytes vendor = 12;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Map &#123;</span><br><span class="line">  optional Header header = 1;</span><br><span class="line"></span><br><span class="line">  repeated Crosswalk crosswalk = 2;// 人行道</span><br><span class="line">  repeated Junction junction = 3;//路口区域</span><br><span class="line">  repeated Lane lane = 4;//车道</span><br><span class="line">  repeated StopSign stop_sign = 5;//停止线</span><br><span class="line">  repeated Signal signal = 6;//信号灯</span><br><span class="line">  repeated YieldSign yield = 7;//让路标志</span><br><span class="line">  repeated Overlap overlap = 8;//重叠区域</span><br><span class="line">  repeated ClearArea clear_area = 9;//禁停区域</span><br><span class="line">  repeated SpeedBump speed_bump = 10;//减速带</span><br><span class="line">  repeated Road road = 11;//道路</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点介绍车道与路口部分。</p>
<p>那接下来我们就看下从XML解析到proto的过程。</p>
<h2 id="高精地图的使用"><a href="#高精地图的使用" class="headerlink" title="高精地图的使用"></a>高精地图的使用</h2><ol>
<li><p><strong>首选</strong>更改全局 flagfile: <em><strong> modules/common/data/global_flagfile.txt </strong></em>这是所有模块的基本flag文件，保持了整体系统的统一。</p>
</li>
<li><p>作为flag标记传递，这样只影响单个进程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;binary&gt; --map_dir=/path/to/your/map</span><br></pre></td></tr></table></figure>
</li>
<li><p>覆盖模块所属的flag文件，生成位置：<br><em>modules/<module_name>/conf/<module_name>.conf</module_name></module_name></em><br>明显地，这个文件也只影响单个模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--flagfile=modules/common/data/global_flagfile.txt</span><br><span class="line"></span><br><span class="line"># Override values from the global flagfile.</span><br><span class="line">--map_dir=/path/to/your/map</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.opendrive.org/docs/OpenDRIVEFormatSpecRev1.4H.pdf" target="_blank" rel="noopener">OpenDRIVE® Format Specification, Rev. 1.4</a><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: OpenDRIVE节点
e=>end: Junction节点
op1=>condition: Header节点|current
op2=>start: Road节点
geo=>start: Geo Reference节点

st(right)->op1(no, right)->op2(right)->e
op1(yes)->geo</textarea><textarea id="flowchart-0-options" style="display: none">{"scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12,"theme":"simple"}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></li>
</ul>


<!--<a href="http://yoursite.com/apollo/module_hdmap.html#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mickeyouyou'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->






</body>
</html>