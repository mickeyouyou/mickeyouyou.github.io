<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>Apollo 高精地图</title>
	<meta name="keywords" content="fzb.me,冯宗宝,冯宗宝的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=3" rel="stylesheet" type="text/css" />
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=3"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>


<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 class="title">Apollo 高精地图</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2018年2月28日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Apollo高精地图规范"><span class="toc-text"><a href="#Apollo&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x89C4;&#x8303;" class="headerlink" title="Apollo&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x89C4;&#x8303;"></a>Apollo&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x89C4;&#x8303;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#格式"><span class="toc-text"><a href="#&#x683C;&#x5F0F;" class="headerlink" title="&#x683C;&#x5F0F;"></a>&#x683C;&#x5F0F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#坐标"><span class="toc-text"><a href="#&#x5750;&#x6807;" class="headerlink" title="&#x5750;&#x6807;"></a>&#x5750;&#x6807;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#车道"><span class="toc-text"><a href="#&#x8F66;&#x9053;" class="headerlink" title="&#x8F66;&#x9053;"></a>&#x8F66;&#x9053;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#路口区域（juction）"><span class="toc-text"><a href="#&#x8DEF;&#x53E3;&#x533A;&#x57DF;&#xFF08;juction&#xFF09;" class="headerlink" title="&#x8DEF;&#x53E3;&#x533A;&#x57DF;&#xFF08;juction&#xFF09;"></a>&#x8DEF;&#x53E3;&#x533A;&#x57DF;&#xFF08;juction&#xFF09;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#高精地图在Apollo"><span class="toc-text"><a href="#&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x5728;Apollo" class="headerlink" title="&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x5728;Apollo"></a>&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x5728;Apollo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取高精地图元素"><span class="toc-text"><a href="#&#x83B7;&#x53D6;&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x5143;&#x7D20;" class="headerlink" title="&#x83B7;&#x53D6;&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x5143;&#x7D20;"></a>&#x83B7;&#x53D6;&#x9AD8;&#x7CBE;&#x5730;&#x56FE;&#x5143;&#x7D20;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-text"><a href="#&#x53C2;&#x8003;" class="headerlink" title="&#x53C2;&#x8003;"></a>&#x53C2;&#x8003;</span></a></li></ol>
<p>关于百度高精地图，开发者提问很多关于制作、使用的问题。这篇文章会基于目前Apollo开放的地图数据部分，解析高精地图的数据格式。</p>
<p><strong>Apollo地图格式对OpenDRIVE都有哪些改动，改动的原因或初衷是什么，改动有什么优势？来自开发者@杨德刚</strong></p>
<p>OpenDRIVE本身设计面向的应用是仿真器，自动驾驶需要更多的信息OpenDRIVE并没有完全提供，所以我们对OpenDRIVE的标准做了部分改动和扩展。</p>
<p>主要改动和扩展了以下几个方面：<strong>一是地图元素形状的表述方式。以车道边界为例，标准OpenDRIVE采用基于Reference Line的曲线方程和偏移的方式来表达边界形状，而Apollo OpenDrive采用绝对坐标序列的方式描述边界形状；</strong>二是元素类型的扩展。例如新增了对于禁停区、人行横道、减速带等元素的独立描述；三是扩展了对于元素之间相互关系的描述。比如新增了junction与junction内元素的关联关系等；除此之外还有一些配合无人驾驶算法的扩展，比如增加了车道中心线到真实道路边界的距离、停止线与红绿灯的关联关系等。改动和扩展后的规格在实现上更加的简单，同时也兼顾了无人驾驶的应用需求。</p>
<h2 id="Apollo高精地图规范"><a href="#Apollo高精地图规范" class="headerlink" title="Apollo高精地图规范"></a>Apollo高精地图规范</h2><h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><p>百度高精地图数据格式采用（XML）文件格式的数据组织方式，是基于国际通用的OpenDrive规范，并根据百度自动驾驶业务需求拓展修改而成。</p>
<p>Apollo高精地图文件的整体结构如下所示：</p>
<p><div id="flowchart-0" class="flow-chart"></div></p>
<h3 id="坐标"><a href="#坐标" class="headerlink" title="坐标"></a>坐标</h3><p>百度高精地图坐标采用WGS84经纬度坐标表示。WGS84为一种大地坐标系，也是目前广泛使用的GPS全球卫星定位系统使用的坐标系。</p>
<h3 id="车道"><a href="#车道" class="headerlink" title="车道"></a>车道</h3><p><strong>道路的reference line 存储在ID为0的车道中，其他车道只存储当前车道的一个边界。例如，reference line右侧的车道只存储车道的右侧边界。</strong></p>
<p><img src="http://7tsys1.com1.z0.glb.clouddn.com/WechatIMG145.jpeg" width="79%"><br>车道 ID 的命名规则:</p>
<ul>
<li>lane section 内唯一</li>
<li>数值连续的</li>
<li>reference line 所在 lane 的 ID 为 0</li>
<li>reference line 左侧 lane 的 ID 向左侧依次递增 (正t轴方向) </li>
<li>reference line 右侧 lane 的 ID 向右侧依次递减(负 t 轴方向) </li>
<li>reference line 必须定义在<code>&lt;center&gt;</code>节点内</li>
</ul>
<p>车道总数目没有限制。Reference line 自身必须为 Lane 0。</p>
<h3 id="路口区域（juction）"><a href="#路口区域（juction）" class="headerlink" title="路口区域（juction）"></a>路口区域（juction）</h3><p>基本的原理比较简单，路口区域用junction结构表达。在Junction内，incoming Road通过Connecting Roads与out-going道路相连。下图展示了一个比较复杂的路口：</p>
<p><img src="http://7tsys1.com1.z0.glb.clouddn.com/WechatIMG146.jpeg" width="79%"></p>
<h2 id="高精地图在Apollo"><a href="#高精地图在Apollo" class="headerlink" title="高精地图在Apollo"></a>高精地图在Apollo</h2><p>在最新的镜像中，Apollo在启动镜像时，会挂载所有地图：</p>
<ul>
<li>map_volume-sunnyvale_big_loop-latest</li>
<li>map_volume-sunnyvale_loop-latest</li>
</ul>
<p>一段道路的相关高精度地图可以放置在如下结构的目录中：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;map_dir&gt;                        # Defined by FLAGS_map_dir</span><br><span class="line">  |-- base_map.xml               # Defined by FLAGS_base_map_filename</span><br><span class="line">  |-- routing_map.bin            # Defined by FLAGS_routing_map_filename</span><br><span class="line">  |-- sim_map.bin                # Defined by FLAGS_sim_map_filename</span><br><span class="line">  |-- default_end_way_point.txt  # Defined by FLAGS_end_way_point_filename</span><br></pre></td></tr></table></figure></p>
<p>可以将可用地图文件名指定为备选列表：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--base_map_filename=&quot;base.xml|base.bin|base.txt&quot;</span><br></pre></td></tr></table></figure></p>
<p>然后Apollo会找到第一个可用的文件加载。一般来说，我们遵循以下扩展模式：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">x.xml  # An OpenDrive formatted map.</span><br><span class="line">x.bin  # A binary pb map.</span><br><span class="line">x.txt  # A text pb map.</span><br></pre></td></tr></table></figure>
<p>高精地图在Apollo中的流转形式</p>
<p><strong>TODO 需要一幅图说明高精度地图从XML格式到PROTO格式的变换和最终的形式。</strong></p>
<p>那接下来我们就看下从XML解析到proto的过程。</p>
<p>XML解析为Proto</p>
<p>不管原始数据格式为什么，在Apollo内部的数据地图的格式为proto。以下为Apollo高精地图的对象定义：<br><figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">// This message defines how we project the ellipsoidal Earth surface to a plane.</span><br><span class="line">message Projection &#123;</span><br><span class="line">  // PROJ.4 setting:</span><br><span class="line">  // &quot;+proj=tmerc +lat_0=&#123;origin.lat&#125; +lon_0=&#123;origin.lon&#125; +k=&#123;scale_factor&#125; +ellps=WGS84 +no_defs&quot;</span><br><span class="line">  optional string proj = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Header &#123;</span><br><span class="line">  optional bytes version = 1;</span><br><span class="line">  optional bytes date = 2;</span><br><span class="line">  optional Projection projection = 3;//坐标系转换</span><br><span class="line">  optional bytes district = 4;</span><br><span class="line">  optional bytes generation = 5;</span><br><span class="line">  optional bytes rev_major = 6;</span><br><span class="line">  optional bytes rev_minor = 7;</span><br><span class="line">  optional double left = 8;</span><br><span class="line">  optional double top = 9;</span><br><span class="line">  optional double right = 10;</span><br><span class="line">  optional double bottom = 11;</span><br><span class="line">  optional bytes vendor = 12;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message Map &#123;</span><br><span class="line">  optional Header header = 1;</span><br><span class="line"></span><br><span class="line">  repeated Crosswalk crosswalk = 2;// 人行道</span><br><span class="line">  repeated Junction junction = 3;//路口区域</span><br><span class="line">  repeated Lane lane = 4;//车道</span><br><span class="line">  repeated StopSign stop_sign = 5;//停止线</span><br><span class="line">  repeated Signal signal = 6;//信号灯</span><br><span class="line">  repeated YieldSign yield = 7;//让路标志</span><br><span class="line">  repeated Overlap overlap = 8;//重叠区域</span><br><span class="line">  repeated ClearArea clear_area = 9;//禁停区域</span><br><span class="line">  repeated SpeedBump speed_bump = 10;//减速带</span><br><span class="line">  repeated Road road = 11;//道路</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其中重点介绍车道与路口部分。</p>
<p>边界<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// Polygon, not necessary convex.</span><br><span class="line">message Polygon &#123;</span><br><span class="line">  repeated apollo.common.PointENU point = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Straight line segment.</span><br><span class="line">message LineSegment &#123;</span><br><span class="line">  repeated apollo.common.PointENU point = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Generalization of a line.</span><br><span class="line">message CurveSegment &#123;</span><br><span class="line">  oneof curve_type &#123;</span><br><span class="line">    LineSegment line_segment = 1;</span><br><span class="line">  &#125;</span><br><span class="line">  optional double s = 6;  // start position (s-coordinate)</span><br><span class="line">  optional apollo.common.PointENU start_position = 7;</span><br><span class="line">  optional double heading = 8; // start orientation</span><br><span class="line">  optional double length = 9;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// An object similar to a line but that need not be straight.</span><br><span class="line">message Curve &#123;</span><br><span class="line">  repeated CurveSegment segment = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>道路Road<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">message BoundaryEdge &#123;</span><br><span class="line">  optional Curve curve = 1;</span><br><span class="line">  enum Type &#123;</span><br><span class="line">    UNKNOWN = 0;</span><br><span class="line">    NORMAL = 1;</span><br><span class="line">    LEFT_BOUNDARY = 2;</span><br><span class="line">    RIGHT_BOUNDARY = 3;</span><br><span class="line">  &#125;;</span><br><span class="line">  optional Type type = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message BoundaryPolygon &#123;</span><br><span class="line">  repeated BoundaryEdge edge = 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// boundary with holes</span><br><span class="line">message RoadBoundary &#123;</span><br><span class="line">  optional BoundaryPolygon outer_polygon = 1;</span><br><span class="line">  // if boundary without hole, hole is null</span><br><span class="line">  repeated BoundaryPolygon hole = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message RoadROIBoundary &#123;</span><br><span class="line">  optional Id id = 1;</span><br><span class="line">  repeated RoadBoundary road_boundaries = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// road section defines a road cross-section, At least one section must be defined in order to</span><br><span class="line">// use a road, If multiple road sections are defined, they must be listed in order along the road</span><br><span class="line">message RoadSection &#123;</span><br><span class="line">  optional Id id = 1;</span><br><span class="line">  // lanes contained in this section</span><br><span class="line">  repeated Id lane_id = 2;</span><br><span class="line">  // boundary of section</span><br><span class="line">  optional RoadBoundary boundary = 3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// The road is a collection of traffic elements, such as lanes, road boundary etc.</span><br><span class="line">// It provides general information about the road.</span><br><span class="line">message Road &#123;</span><br><span class="line">  optional Id id = 1;</span><br><span class="line">  repeated RoadSection section = 2;</span><br><span class="line"></span><br><span class="line">  // if lane road not in the junction, junction id is null.</span><br><span class="line">  optional Id junction_id = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>车道Lane</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">message LaneBoundaryType &#123;</span><br><span class="line">  enum Type &#123;</span><br><span class="line">    UNKNOWN = 0;</span><br><span class="line">    DOTTED_YELLOW = 1;</span><br><span class="line">    DOTTED_WHITE = 2;</span><br><span class="line">    SOLID_YELLOW = 3;</span><br><span class="line">    SOLID_WHITE = 4;</span><br><span class="line">    DOUBLE_YELLOW = 5;</span><br><span class="line">    CURB = 6;</span><br><span class="line">  &#125;;</span><br><span class="line">  // Offset relative to the starting point of boundary</span><br><span class="line">  optional double s = 1;</span><br><span class="line">  // support multiple types</span><br><span class="line">  repeated Type types = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message LaneBoundary &#123;</span><br><span class="line">  optional Curve curve = 1;</span><br><span class="line"></span><br><span class="line">  optional double length = 2;</span><br><span class="line">  // indicate whether the lane boundary exists in real world</span><br><span class="line">  optional bool virtual = 3;</span><br><span class="line">  // in ascending order of s</span><br><span class="line">  repeated LaneBoundaryType boundary_type = 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Association between central point to closest boundary.</span><br><span class="line">message LaneSampleAssociation &#123;</span><br><span class="line">  optional double s = 1;</span><br><span class="line">  optional double width = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// A lane is part of a roadway, that is designated for use by a single line of vehicles.</span><br><span class="line">// Most public roads (include highways) have more than two lanes.</span><br><span class="line">message Lane &#123;</span><br><span class="line">  optional Id id = 1;</span><br><span class="line"></span><br><span class="line">  // Central lane as reference trajectory, not necessary to be the geometry central.</span><br><span class="line">  optional Curve central_curve = 2;</span><br><span class="line"></span><br><span class="line">  // Lane boundary curve.</span><br><span class="line">  optional LaneBoundary left_boundary = 3;</span><br><span class="line">  optional LaneBoundary right_boundary = 4;</span><br><span class="line"></span><br><span class="line">  // in meters.</span><br><span class="line">  optional double length = 5;</span><br><span class="line"></span><br><span class="line">  // Speed limit of the lane, in meters per second.</span><br><span class="line">  optional double speed_limit = 6;</span><br><span class="line"></span><br><span class="line">  repeated Id overlap_id = 7;</span><br><span class="line"></span><br><span class="line">  // All lanes can be driving into (or from).</span><br><span class="line">  repeated Id predecessor_id = 8;</span><br><span class="line">  repeated Id successor_id = 9;</span><br><span class="line"></span><br><span class="line">  // Neighbor lanes on the same direction.</span><br><span class="line">  repeated Id left_neighbor_forward_lane_id = 10;</span><br><span class="line">  repeated Id right_neighbor_forward_lane_id = 11;</span><br><span class="line"></span><br><span class="line">  enum LaneType &#123;</span><br><span class="line">    NONE = 1;</span><br><span class="line">    CITY_DRIVING = 2;</span><br><span class="line">    BIKING = 3;</span><br><span class="line">    SIDEWALK = 4;</span><br><span class="line">    PARKING = 5;</span><br><span class="line">  &#125;;</span><br><span class="line">  optional LaneType type = 12;</span><br><span class="line"></span><br><span class="line">  enum LaneTurn &#123;</span><br><span class="line">    NO_TURN = 1;</span><br><span class="line">    LEFT_TURN = 2;</span><br><span class="line">    RIGHT_TURN = 3;</span><br><span class="line">    U_TURN = 4;</span><br><span class="line">  &#125;;</span><br><span class="line">  optional LaneTurn turn = 13;</span><br><span class="line"></span><br><span class="line">  repeated Id left_neighbor_reverse_lane_id = 14;</span><br><span class="line">  repeated Id right_neighbor_reverse_lane_id = 15;</span><br><span class="line"></span><br><span class="line">  optional Id junction_id = 16;</span><br><span class="line"></span><br><span class="line">  // Association between central point to closest boundary.</span><br><span class="line">  repeated LaneSampleAssociation left_sample = 17;</span><br><span class="line">  repeated LaneSampleAssociation right_sample = 18;</span><br><span class="line"></span><br><span class="line">  enum LaneDirection &#123;</span><br><span class="line">    FORWARD = 1;</span><br><span class="line">    BACKWARD = 2;</span><br><span class="line">    BIDIRECTION = 3;</span><br><span class="line">  &#125;</span><br><span class="line">  optional LaneDirection direction = 19;</span><br><span class="line"></span><br><span class="line">  // Association between central point to closest road boundary.</span><br><span class="line">  repeated LaneSampleAssociation left_road_sample = 20;</span><br><span class="line">  repeated LaneSampleAssociation right_road_sample = 21;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>路口Junction<br>对于路口区域的描述<br><figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line">// An junction is the junction at-grade of two or more roads crossing.</span><br><span class="line">message Junction &#123;</span><br><span class="line">  optional Id id = 1;</span><br><span class="line">  optional Polygon polygon = 2;</span><br><span class="line">  repeated Id overlap_id = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Proto格式地图的使用</p>
<p>这个时候的的地图格式，可以为Apollo中的多个模块，或者统一的方法所使用。</p>
<h2 id="获取高精地图元素"><a href="#获取高精地图元素" class="headerlink" title="获取高精地图元素"></a>获取高精地图元素</h2><p>有了原始从xml格式到protobuf的数据之后，就可以访问这些高精地图的元素，Apollo高精地图提供如下的方法获取元素：<br><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">LoadMapFromFile (<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;map_filename) load <span class="built_in">map</span> from local file </span><br><span class="line">GetLaneById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetJunctionById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetSignalById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetCrosswalkById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetStopSignById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetYieldSignById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetClearAreaById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetSpeedBumpById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetOverlapById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetRoadById (<span class="keyword">const</span> Id &amp;id) <span class="keyword">const</span></span><br><span class="line">GetLanes (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; LaneInfoConstPtr &gt; *lanes) <span class="keyword">const</span></span><br><span class="line">    get all lanes in certain range More...</span><br><span class="line">GetJunctions (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; JunctionInfoConstPtr &gt; *junctions) <span class="keyword">const</span></span><br><span class="line">    get all junctions in certain range More...</span><br><span class="line">GetCrosswalks (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; CrosswalkInfoConstPtr &gt; *crosswalks) <span class="keyword">const</span></span><br><span class="line">    get all crosswalks in certain range More...</span><br><span class="line">GetSignals (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; SignalInfoConstPtr &gt; *signals) <span class="keyword">const</span></span><br><span class="line">    get all signals in certain range More...</span><br><span class="line">GetStopSigns (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; StopSignInfoConstPtr &gt; *stop_signs) <span class="keyword">const</span></span><br><span class="line">    get all stop signs in certain range More...</span><br><span class="line">GetYieldSigns (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; YieldSignInfoConstPtr &gt; *yield_signs) <span class="keyword">const</span></span><br><span class="line">    get all yield signs in certain range More...</span><br><span class="line">GetClearAreas (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; ClearAreaInfoConstPtr &gt; *clear_areas) <span class="keyword">const</span></span><br><span class="line">    get all clear areas in certain range More...</span><br><span class="line">GetSpeedBumps (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; SpeedBumpInfoConstPtr &gt; *speed_bumps) <span class="keyword">const</span></span><br><span class="line">    get all speed bumps in certain range More...</span><br><span class="line">GetRoads (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; RoadInfoConstPtr &gt; *roads) <span class="keyword">const</span></span><br><span class="line">    get all roads in certain range More...</span><br><span class="line">GetNearestLane (<span class="keyword">const</span> apollo::common::PointENU &amp;point, LaneInfoConstPtr *nearest_lane, <span class="keyword">double</span> *nearest_s, <span class="keyword">double</span> *nearest_l) <span class="keyword">const</span></span><br><span class="line">    get nearest lane from target point, More...</span><br><span class="line">GetNearestLaneWithHeading (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">const</span> <span class="keyword">double</span> distance, <span class="keyword">const</span> <span class="keyword">double</span> central_heading, <span class="keyword">const</span> <span class="keyword">double</span> max_heading_difference, LaneInfoConstPtr *nearest_lane, <span class="keyword">double</span> *nearest_s, <span class="keyword">double</span> *nearest_l) <span class="keyword">const</span></span><br><span class="line">    get the nearest lane within a certain range by pose More...</span><br><span class="line">GetLanesWithHeading (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">const</span> <span class="keyword">double</span> distance, <span class="keyword">const</span> <span class="keyword">double</span> central_heading, <span class="keyword">const</span> <span class="keyword">double</span> max_heading_difference, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; LaneInfoConstPtr &gt; *lanes) <span class="keyword">const</span></span><br><span class="line">    get all lanes within a certain range by pose More...</span><br><span class="line">GetRoadBoundaries (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">double</span> radius, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; RoadROIBoundaryPtr &gt; *road_boundaries, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; JunctionBoundaryPtr &gt; *junctions) <span class="keyword">const</span></span><br><span class="line">    get all road <span class="keyword">and</span> junctions boundaries within certain range More...</span><br><span class="line">GetForwardNearestSignalsOnLane (<span class="keyword">const</span> apollo::common::PointENU &amp;point, <span class="keyword">const</span> <span class="keyword">double</span> distance, <span class="built_in">std</span>::<span class="built_in">vector</span>&lt; SignalInfoConstPtr &gt; *signals) <span class="keyword">const</span></span><br><span class="line">    get forward nearest signals within certain range on the lane <span class="keyword">if</span> there are two signals related to one stop line, <span class="keyword">return</span> both signals. More</span><br></pre></td></tr></table></figure></p>
<p>提供高精地图元素获取的方法实现类：<code>apollo::hdmap::HDMapImpl</code>，详见<a href="https://apolloauto.github.io/doxygen/apollo/classapollo_1_1hdmap_1_1HDMapImpl.html" target="_blank" rel="noopener">apollo::hdmap::HDMapImpl Class Reference</a></p>
<figure class="highlight cpp"><figcaption><span>modules/planning/reference_line/reference_line_provider.cc</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="keyword">bool</span> ReferenceLineProvider::GetReferenceLinesFromRelativeMap(</span><br><span class="line">    <span class="keyword">const</span> relative_map::MapMsg &amp;relative_map,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;ReferenceLine&gt; *reference_line,</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">list</span>&lt;hdmap::RouteSegments&gt; *segments) &#123;</span><br><span class="line">  <span class="keyword">if</span> (relative_map.navigation_path_size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> *hdmap = HDMapUtil::BaseMapPtr();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> path_pair : relative_map.navigation_path()) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;lane_id = path_pair.first;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> &amp;path_points = path_pair.second.path().path_point();</span><br><span class="line">    <span class="keyword">auto</span> lane_ptr = hdmap-&gt;GetLaneById(hdmap::MakeMapId(lane_id));</span><br><span class="line">    RouteSegments segment;</span><br><span class="line">    segment.emplace_back(lane_ptr, <span class="number">0.0</span>, lane_ptr-&gt;total_length());</span><br><span class="line">    segment.SetCanExit(<span class="literal">true</span>);</span><br><span class="line">    segment.SetId(lane_id);</span><br><span class="line">    segment.SetNextAction(routing::FORWARD);</span><br><span class="line">    segment.SetIsOnSegment(<span class="literal">true</span>);</span><br><span class="line">    segment.SetStopForDestination(<span class="literal">false</span>);</span><br><span class="line">    segment.SetPreviousAction(routing::FORWARD);</span><br><span class="line">    segments-&gt;emplace_back(segment);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;ReferencePoint&gt; ref_points;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> <span class="keyword">auto</span> &amp;path_point : path_points) &#123;</span><br><span class="line">      ref_points.emplace_back(</span><br><span class="line">          MapPathPoint&#123;Vec2d&#123;path_point.x(), path_point.y()&#125;,</span><br><span class="line">                       path_point.theta(),</span><br><span class="line">                       LaneWaypoint(lane_ptr, path_point.s())&#125;,</span><br><span class="line">          path_point.kappa(), path_point.dkappa(), <span class="number">0.0</span>, <span class="number">0.0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    reference_line-&gt;emplace_back(ref_points.begin(), ref_points.end());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><p>更改全局 flagfile: <em><strong> modules/common/data/global_flagfile.txt </strong></em>这是所有模块的基本flag文件，保持了整体系统的统一。</p>
</li>
<li><p>作为flag标记传递，这样只影响单个进程</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&lt;binary&gt; --map_dir=/path/to/your/map</span><br></pre></td></tr></table></figure>
</li>
<li><p>覆盖模块所属的flag文件，生成位置：<br><em>modules/<module_name>/conf/<module_name>.conf</module_name></module_name></em><br>明显地，这个文件也只影响单个模块</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--flagfile=modules/common/data/global_flagfile.txt</span><br><span class="line"></span><br><span class="line"># Override values from the global flagfile.</span><br><span class="line">--map_dir=/path/to/your/map</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>Question</p>
<ul>
<li>对于两条相连的路，可以用路口（junction)的概念描述，如果是桥梁的描述方式为？</li>
<li></li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="http://www.opendrive.org/docs/OpenDRIVEFormatSpecRev1.4H.pdf" target="_blank" rel="noopener">OpenDRIVE® Format Specification, Rev. 1.4</a><script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.2.7/raphael.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/flowchart/1.6.5/flowchart.min.js"></script><textarea id="flowchart-0-code" style="display: none">st=>start: OpenDRIVE节点
e=>end: Junction节点
op1=>condition: Header节点|current
op2=>start: Road节点
geo=>start: Geo Reference节点

st(right)->op1(no, right)->op2(right)->e
op1(yes)->geo</textarea><textarea id="flowchart-0-options" style="display: none">{"theme":"simple","scale":1,"line-width":2,"line-length":50,"text-margin":10,"font-size":12}</textarea><script>  var code = document.getElementById("flowchart-0-code").value;  var options = JSON.parse(decodeURIComponent(document.getElementById("flowchart-0-options").value));  var diagram = flowchart.parse(code);  diagram.drawSVG("flowchart-0", options);</script></li>
</ul>


<!--<a href="http://yoursite.com/apollo/module_hdmap.html#disqus_thread" class="article-comment-link">Comments</a>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'mickeyouyou'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
-->
<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</body>
</html>