<html>
<head>
	
	<!-- hexo-inject:begin --><!-- hexo-inject:end --><title>如何适配一辆新车？</title>
	<meta name="keywords" content="fzb.me,冯宗宝,冯宗宝的blog" />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
	   <link href="/css/main.css?v=4.3" rel="stylesheet" type="text/css" />
    
        <script src="/js/util.js"></script>
        <script>
            if(isMobile()) {
                loadjscssfile('../css/mobile.css', 'css');
            } else {
                loadjscssfile('../css/desktop.css', 'css');
            }
        </script> 
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	   <link rel="shortcut icon" type="image/x-icon" href="/rocket_128px_1215034_easyicon.net.ico?v=4.3"/><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>

<body>


<!-- hexo-inject:begin --><!-- hexo-inject:end --><h2 class="title">如何适配一辆新车？</h2>
<!---
<div style="text-align:center;margin-top: -10px;">
<div class="article-category">
发表于2018年9月20日




 </div>
--->
</div>

<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-text"><a href="#&#x6982;&#x8FF0;" class="headerlink" title="&#x6982;&#x8FF0;"></a>&#x6982;&#x8FF0;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1、准备DBC文件"><span class="toc-text"><a href="#1&#x3001;&#x51C6;&#x5907;DBC&#x6587;&#x4EF6;" class="headerlink" title="1&#x3001;&#x51C6;&#x5907;DBC&#x6587;&#x4EF6;"></a>1&#x3001;&#x51C6;&#x5907;DBC&#x6587;&#x4EF6;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2、生成信号列表和数据类"><span class="toc-text"><a href="#2&#x3001;&#x751F;&#x6210;&#x4FE1;&#x53F7;&#x5217;&#x8868;&#x548C;&#x6570;&#x636E;&#x7C7B;" class="headerlink" title="2&#x3001;&#x751F;&#x6210;&#x4FE1;&#x53F7;&#x5217;&#x8868;&#x548C;&#x6570;&#x636E;&#x7C7B;"></a>2&#x3001;&#x751F;&#x6210;&#x4FE1;&#x53F7;&#x5217;&#x8868;&#x548C;&#x6570;&#x636E;&#x7C7B;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3、收集车辆反馈信号"><span class="toc-text"><a href="#3&#x3001;&#x6536;&#x96C6;&#x8F66;&#x8F86;&#x53CD;&#x9988;&#x4FE1;&#x53F7;" class="headerlink" title="3&#x3001;&#x6536;&#x96C6;&#x8F66;&#x8F86;&#x53CD;&#x9988;&#x4FE1;&#x53F7;"></a>3&#x3001;&#x6536;&#x96C6;&#x8F66;&#x8F86;&#x53CD;&#x9988;&#x4FE1;&#x53F7;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4、控制信号的下发执行"><span class="toc-text"><a href="#4&#x3001;&#x63A7;&#x5236;&#x4FE1;&#x53F7;&#x7684;&#x4E0B;&#x53D1;&#x6267;&#x884C;" class="headerlink" title="4&#x3001;&#x63A7;&#x5236;&#x4FE1;&#x53F7;&#x7684;&#x4E0B;&#x53D1;&#x6267;&#x884C;"></a>4&#x3001;&#x63A7;&#x5236;&#x4FE1;&#x53F7;&#x7684;&#x4E0B;&#x53D1;&#x6267;&#x884C;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5、信号控制问题"><span class="toc-text"><a href="#5&#x3001;&#x4FE1;&#x53F7;&#x63A7;&#x5236;&#x95EE;&#x9898;" class="headerlink" title="5&#x3001;&#x4FE1;&#x53F7;&#x63A7;&#x5236;&#x95EE;&#x9898;"></a>5&#x3001;&#x4FE1;&#x53F7;&#x63A7;&#x5236;&#x95EE;&#x9898;</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考日志"><span class="toc-text"><a href="#&#x53C2;&#x8003;&#x65E5;&#x5FD7;" class="headerlink" title="&#x53C2;&#x8003;&#x65E5;&#x5FD7;"></a>&#x53C2;&#x8003;&#x65E5;&#x5FD7;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1、不能识别控制信号和反馈信号导致的一个编译错误"><span class="toc-text"><a href="#1&#x3001;&#x4E0D;&#x80FD;&#x8BC6;&#x522B;&#x63A7;&#x5236;&#x4FE1;&#x53F7;&#x548C;&#x53CD;&#x9988;&#x4FE1;&#x53F7;&#x5BFC;&#x81F4;&#x7684;&#x4E00;&#x4E2A;&#x7F16;&#x8BD1;&#x9519;&#x8BEF;" class="headerlink" title="1&#x3001;&#x4E0D;&#x80FD;&#x8BC6;&#x522B;&#x63A7;&#x5236;&#x4FE1;&#x53F7;&#x548C;&#x53CD;&#x9988;&#x4FE1;&#x53F7;&#x5BFC;&#x81F4;&#x7684;&#x4E00;&#x4E2A;&#x7F16;&#x8BD1;&#x9519;&#x8BEF;"></a>1&#x3001;&#x4E0D;&#x80FD;&#x8BC6;&#x522B;&#x63A7;&#x5236;&#x4FE1;&#x53F7;&#x548C;&#x53CD;&#x9988;&#x4FE1;&#x53F7;&#x5BFC;&#x81F4;&#x7684;&#x4E00;&#x4E2A;&#x7F16;&#x8BD1;&#x9519;&#x8BEF;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2、未能正确进入自动驾驶模式，且有信号超时的部分日志"><span class="toc-text"><a href="#2&#x3001;&#x672A;&#x80FD;&#x6B63;&#x786E;&#x8FDB;&#x5165;&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6A21;&#x5F0F;&#xFF0C;&#x4E14;&#x6709;&#x4FE1;&#x53F7;&#x8D85;&#x65F6;&#x7684;&#x90E8;&#x5206;&#x65E5;&#x5FD7;" class="headerlink" title="2&#x3001;&#x672A;&#x80FD;&#x6B63;&#x786E;&#x8FDB;&#x5165;&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6A21;&#x5F0F;&#xFF0C;&#x4E14;&#x6709;&#x4FE1;&#x53F7;&#x8D85;&#x65F6;&#x7684;&#x90E8;&#x5206;&#x65E5;&#x5FD7;"></a>2&#x3001;&#x672A;&#x80FD;&#x6B63;&#x786E;&#x8FDB;&#x5165;&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6A21;&#x5F0F;&#xFF0C;&#x4E14;&#x6709;&#x4FE1;&#x53F7;&#x8D85;&#x65F6;&#x7684;&#x90E8;&#x5206;&#x65E5;&#x5FD7;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3、不断循环进入退出自动驾驶模式的日志（主要是经过了guardian模块的原因）："><span class="toc-text"><a href="#3&#x3001;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#x8FDB;&#x5165;&#x9000;&#x51FA;&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6A21;&#x5F0F;&#x7684;&#x65E5;&#x5FD7;&#xFF08;&#x4E3B;&#x8981;&#x662F;&#x7ECF;&#x8FC7;&#x4E86;guardian&#x6A21;&#x5757;&#x7684;&#x539F;&#x56E0;&#xFF09;&#xFF1A;" class="headerlink" title="3&#x3001;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#x8FDB;&#x5165;&#x9000;&#x51FA;&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6A21;&#x5F0F;&#x7684;&#x65E5;&#x5FD7;&#xFF08;&#x4E3B;&#x8981;&#x662F;&#x7ECF;&#x8FC7;&#x4E86;guardian&#x6A21;&#x5757;&#x7684;&#x539F;&#x56E0;&#xFF09;&#xFF1A;"></a>3&#x3001;&#x4E0D;&#x65AD;&#x5FAA;&#x73AF;&#x8FDB;&#x5165;&#x9000;&#x51FA;&#x81EA;&#x52A8;&#x9A7E;&#x9A76;&#x6A21;&#x5F0F;&#x7684;&#x65E5;&#x5FD7;&#xFF08;&#x4E3B;&#x8981;&#x662F;&#x7ECF;&#x8FC7;&#x4E86;guardian&#x6A21;&#x5757;&#x7684;&#x539F;&#x56E0;&#xFF09;&#xFF1A;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#转向调试"><span class="toc-text"><a href="#&#x8F6C;&#x5411;&#x8C03;&#x8BD5;" class="headerlink" title="&#x8F6C;&#x5411;&#x8C03;&#x8BD5;"></a>&#x8F6C;&#x5411;&#x8C03;&#x8BD5;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#油门调试"><span class="toc-text"><a href="#&#x6CB9;&#x95E8;&#x8C03;&#x8BD5;" class="headerlink" title="&#x6CB9;&#x95E8;&#x8C03;&#x8BD5;"></a>&#x6CB9;&#x95E8;&#x8C03;&#x8BD5;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TODO"><span class="toc-text"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#发现的一些问题："><span class="toc-text"><a href="#&#x53D1;&#x73B0;&#x7684;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF1A;" class="headerlink" title="&#x53D1;&#x73B0;&#x7684;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF1A;"></a>&#x53D1;&#x73B0;&#x7684;&#x4E00;&#x4E9B;&#x95EE;&#x9898;&#xFF1A;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20180816今日计划"><span class="toc-text"><a href="#20180816&#x4ECA;&#x65E5;&#x8BA1;&#x5212;" class="headerlink" title="20180816&#x4ECA;&#x65E5;&#x8BA1;&#x5212;"></a>20180816&#x4ECA;&#x65E5;&#x8BA1;&#x5212;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20180817计划测试内容"><span class="toc-text"><a href="#20180817&#x8BA1;&#x5212;&#x6D4B;&#x8BD5;&#x5185;&#x5BB9;" class="headerlink" title="20180817&#x8BA1;&#x5212;&#x6D4B;&#x8BD5;&#x5185;&#x5BB9;"></a>20180817&#x8BA1;&#x5212;&#x6D4B;&#x8BD5;&#x5185;&#x5BB9;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20180818-计划"><span class="toc-text"><a href="#20180818-&#x8BA1;&#x5212;" class="headerlink" title="20180818 &#x8BA1;&#x5212;"></a>20180818 &#x8BA1;&#x5212;</span></a></li></ol></li></ol>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>如何在Apollo适配一个新车型？开发者有各式各样的车，有乘用车，有非乘用车，不得不说这是个挑战，因为需要对车辆反馈和可以控制的信号比较了解，也就是说车辆需要具备线控是适配Apollo基础条件。以下总结了适配一辆新车大致的几个阶段，供理解与参考：</p>
<p>主要的逻辑如下：</p>
<ol>
<li>车辆反馈、控制信号在CANBUS模块的适配</li>
<li>反馈信号的测试</li>
<li>控制信号的测试</li>
<li>控制参数的调整</li>
</ol>
<blockquote>
<p>尽管已经有相应的文档来突出逻辑的主干部分，但过程很重要，坑也有必要重点指出，让后面的开发者着重检查。</p>
</blockquote>
<p>适配一辆新车，最重要的还是适配控制层。我引用一张Apollo数据与控制流程图，指示出其中需要适配的部分。</p>
<p><img alt="apollo software data and control flow " src="http://agroup-bos.su.bcebos.com/253ab3fb7d5418f6048cd3f406a91bb02bd9b74c" width="99%"></p>
<blockquote>
<p>Note:图中从Control到Canbus的方式，是Apollo3.0之前的逻辑，新版本加入了对控制指令在Guardian模块的安全过滤，可以通过配置不经过Guardian模块。</p>
</blockquote>
<p>不要怕繁琐，针对此图，我们再描述一遍控制的逻辑。</p>
<ul>
<li>控制模块负责解析车辆可以识别的控制信号，将该指令通过<code>ControlCommand</code>(topic:<code>/apollo/control</code>)发布出来；</li>
<li>Canbus模块是通过Can卡发送上游控制模块（或者由Guardian模块过滤过之后的）控制命令与车辆交互的；</li>
<li>Canbus一方面执行控制指令，另外一方面将车辆底盘的信号，反馈给Chassis（Topic:<code>/apollo/canbus/chassis</code>、<code>/apollo/canbus/chassis_detail</code>）;</li>
</ul>
<h2 id="1、准备DBC文件"><a href="#1、准备DBC文件" class="headerlink" title="1、准备DBC文件"></a>1、准备DBC文件</h2><p>DBC文件以及经过CANOE等工具验证没有问题，其中包含Apollo所需要的控制信号、反馈信号、耗时要求等内容。文档参见：<a href="http://apollo-homepage.bj.bcebos.com/Apollo_by_wire_requirement.xlsx" target="_blank" rel="noopener">http://apollo-homepage.bj.bcebos.com/Apollo_by_wire_requirement.xlsx</a></p>
<h2 id="2、生成信号列表和数据类"><a href="#2、生成信号列表和数据类" class="headerlink" title="2、生成信号列表和数据类"></a>2、生成信号列表和数据类</h2><p>需要将信号的控制、字段和类型抽取出来是个体力活，而且对安全性要求较高。可以使用Apollo提供的工具来完成。</p>
<p>只不过要提醒一点的是，该工具在厂家自己适配的<code>SENDER</code>中不能正确识别命令下发和反馈信号，导致生成的信号控制类不可用。用Pro车型的DBC文件举例<code>Pro_V3.dbc</code>：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">BO_ 293 motorPositionGasBrakeSideC: 8 gasBrakeSideC</span><br><span class="line"> SG_ motorPositionSensor3_GB_C : 32|16@1+ (1,0) [0|32768] <span class="string">""</span>  ACU</span><br><span class="line"> SG_ motorPositionSensor2_GB_C : 16|16@1+ (1,0) [0|32768] <span class="string">""</span>  ACU</span><br><span class="line"> SG_ motorPositionSensor1_GB_C : 0|16@1+ (1,0) [0|32768] <span class="string">""</span>  ACU</span><br><span class="line"> SG_ motorPosition_GB_C : 48|16@1+ (1,0) [0|32768] <span class="string">""</span>  ACU</span><br></pre></td></tr></table></figure></p>
<p>对于厂商来说，pro来说，应该从DBC文件中获取行最后一个字段，作为<code>pro_conf.yml</code> 配置文件中<code>sender</code> 字段的值，这样才可以生成正确的下发报文和反馈报文。</p>
<p><strong>如何识别下发报文和反馈报文？</strong><br>一般来说，对字段有<code>set</code>操作的可以认为是控制指令下发操作；对字段有<code>get</code> 操作的，一般是获取来自车辆底盘的信号。</p>
<p><strong>换挡操作的报文下发</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// config detail: &#123;<span class="string">'name'</span>: <span class="string">'gearSelection'</span>, <span class="string">'enum'</span>: &#123;8: <span class="string">'GEARSELECTION_D'</span>, 1: <span class="string">'GEARSELECTION_P'</span>, 2: <span class="string">'GEARSELECTION_R'</span>, 4: <span class="string">'GEARSELECTION_N'</span>&#125;, <span class="string">'precision'</span>: 1.0, <span class="string">'len'</span>: 4, <span class="string">'is_signed_var'</span>: False, <span class="string">'offset'</span>: 0.0, <span class="string">'physical_range'</span>: <span class="string">'[0|0]'</span>, <span class="string">'bit'</span>: 2, <span class="string">'type'</span>: <span class="string">'enum'</span>, <span class="string">'order'</span>: <span class="string">'intel'</span>, <span class="string">'physical_unit'</span>: <span class="string">''</span>&#125;</span><br><span class="line">void Gatewaycommand300::set_p_gearselection(uint8_t* data,</span><br><span class="line">    Gatewaycommand_300::GearselectionType gearselection) &#123;</span><br><span class="line">  int x = gearselection;</span><br><span class="line"></span><br><span class="line">  Byte to_set(data + 0);</span><br><span class="line">  to_set.set_value(x, 2, 4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>一个换挡反馈报文</strong><br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// config detail: &#123;<span class="string">'name'</span>: <span class="string">'gearselection'</span>, <span class="string">'enum'</span>: &#123;8: <span class="string">'GEARSELECTION_D'</span>, 1: <span class="string">'GEARSELECTION_P'</span>, 2: <span class="string">'GEARSELECTION_R'</span>, 4: <span class="string">'GEARSELECTION_N'</span>&#125;, <span class="string">'precision'</span>: 1.0, <span class="string">'len'</span>: 4, <span class="string">'is_signed_var'</span>: False, <span class="string">'offset'</span>: 0.0, <span class="string">'physical_range'</span>: <span class="string">'[0|0]'</span>, <span class="string">'bit'</span>: 2, <span class="string">'type'</span>: <span class="string">'enum'</span>, <span class="string">'order'</span>: <span class="string">'intel'</span>, <span class="string">'physical_unit'</span>: <span class="string">''</span>&#125;</span><br><span class="line">Gatewaycommand_300::GearselectionType Gatewaycommand300::gearselection(const std::uint8_t* bytes, int32_t length) const &#123;</span><br><span class="line">  Byte t0(bytes + 0);</span><br><span class="line">  int32_t x = t0.get_byte(2, 4);</span><br><span class="line"></span><br><span class="line">  Gatewaycommand_300::GearselectionType ret =  static_cast&lt;Gatewaycommand_300::GearselectionType&gt;(x);</span><br><span class="line">  <span class="built_in">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>参考的一个<code>pro_conf.yml</code>配置。文件中对<code>Sender</code>字段的配置，该字段默认值为<code>MAB</code> 是林肯车型适配的<code>sender</code>。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dbc_file: Pro_v3.dbc</span><br><span class="line">protocol_conf: pro.yml</span><br><span class="line">car_type: pro</span><br><span class="line">sender_list: []</span><br><span class="line">sender: MAB</span><br><span class="line">black_list: []</span><br><span class="line"></span><br><span class="line">output_dir: output/</span><br></pre></td></tr></table></figure>
<p>最后生成的内容分为两部分：1、原始信号反馈、控制类；2、底盘相关字段；</p>
<h2 id="3、收集车辆反馈信号"><a href="#3、收集车辆反馈信号" class="headerlink" title="3、收集车辆反馈信号"></a>3、收集车辆反馈信号</h2><p>生成基本的控制信号类方法和信号字段之后，我们需要将他们整合到Canbus模块。</p>
<p>1、反馈信号的原始类文件，即vehicle目录下的<code>audi</code>目录，完全拷贝到`modules/canbus/vehicle/下；</p>
<p>2、将生成的<code>audi.proto</code>文件中的所有message，复制到<code>modules/canbus/proto/chassis_detail.proto</code>尾部追加；</p>
<p>3、在<code>chassis_detail.proto</code>中的message类型ChassisDetail尾部追加<code>Audi audi</code>字段,以此作为适配反馈和控制的底盘；</p>
<p>4、在<code>modules/canbus/proto/vehicle.proto</code>的VehicleBrand类型的massage中追加<code>AUDI_Q7</code>,主要用作CAN卡的启动配置选择；</p>
<p>5、在<code>modules/canbus/conf</code>下新增或者修改已存配置文件<code>canbus_conf.pb.txt</code>,在其中brand字段填写上一步配置的<code>AUDI_Q7</code>字段，并检查CAN卡的通道是否是<code>CHANNEL_ID_ZERO</code>,如果不是也可以在此处配置；另外为了调试方便，还可以打开CAN卡的调试模式（enable_debug_mode:true）、反馈日志（enable_receiver_log:true）、发送日志（enable_sender_log:true）;</p>
<p>这些配置步骤的准备工作，如果正常，就能在启动<code>script/bootscript.sh</code>脚本之后，看到Monitor对CAN卡硬件的监控状态为OK啦。接下来看就可以从底盘信号中拿取信号，试着往外发布了。</p>
<figure class="highlight cc"><table><tr><td class="code"><pre><span class="line">Chassis AudiController::chassis() &#123;</span><br><span class="line">  chassis_.Clear();</span><br><span class="line"></span><br><span class="line">  ChassisDetail chassis_detail;</span><br><span class="line">  message_manager_-&gt;GetSensorData(&amp;chassis_detail);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 21, 22, previously 1, 2</span></span><br><span class="line">  <span class="keyword">if</span> (driving_mode() == Chassis::EMERGENCY_MODE) &#123;</span><br><span class="line">    set_chassis_error_code(Chassis::NO_ERROR);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  chassis_.set_driving_mode(driving_mode());</span><br><span class="line">  chassis_.set_error_code(chassis_error_code());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 3</span></span><br><span class="line">  chassis_.set_engine_started(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 4 此处从底盘信号engine_705中获取发动机转速，并赋值给chassis.engine_rpm </span></span><br><span class="line">  <span class="keyword">if</span>(!chassis_detail.audi().has_engine_705() ||</span><br><span class="line">   !chassis_detail.audi().engine_705().has_enginerpm()) &#123;</span><br><span class="line">    chassis_.set_engine_rpm(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (chassis_detail.audi().has_engine_705() &amp;&amp; </span><br><span class="line">    chassis_detail.audi().engine_705().has_enginerpm()) &#123;</span><br><span class="line">    chassis_.set_engine_rpm(chassis_detail.audi().engine_705().enginerpm());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 其他反馈信号也是一样道理</span></span><br><span class="line">  <span class="keyword">return</span> chassis_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>代码文件为<code>audi_control.cc</code></p>
</blockquote>
<p>编写完信号获取的代码之后，编译Apollo，再次进入，并启动发动机，观察结果：<br><img src="http://agroup-bos.su.bcebos.com/2256039a322f9a2b4ef7a1c7ded1c19099cfc61a" alt="反馈信号"></p>
<p>如图，我们通过查看topic（rostopic echo）已经拿到了发动机转速信息。其他信号是一样的道理。</p>
<h2 id="4、控制信号的下发执行"><a href="#4、控制信号的下发执行" class="headerlink" title="4、控制信号的下发执行"></a>4、控制信号的下发执行</h2><p>控制信号的下发，简言之就是对车辆的操作，发送ControlCommand，即topic为<code>apollo/control</code>。</p>
<p>同样，控制型号需要通过CANBUS模块发送给车辆执行的内容，所以接下来就是完成控制信号的控制。</p>
<p>要完善的有几个内容：</p>
<ul>
<li>进入自动驾驶模式的方式；</li>
<li>退出自动驾驶的方法；</li>
<li>刹车信号的控制；</li>
<li>加速信号的控制；</li>
<li>转向信号的控制；</li>
<li>换挡信号的控制；</li>
</ul>
<figure class="highlight cc"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 反馈OK,以确保跟车辆底盘握手成功。</span></span><br><span class="line">ErrorCode AudiController::EnableAutoMode() &#123;</span><br><span class="line">  <span class="keyword">if</span> (driving_mode() == Chassis::COMPLETE_AUTO_DRIVE) &#123;</span><br><span class="line">    AINFO &lt;&lt; <span class="string">"already in COMPLETE_AUTO_DRIVE mode"</span>;</span><br><span class="line">    <span class="keyword">return</span> ErrorCode::OK;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//brake_60_-&gt;set_enable();</span></span><br><span class="line">  <span class="comment">//throttle_62_-&gt;set_enable();</span></span><br><span class="line">  gatewaycommand_300_-&gt;set_magneticclutch(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  can_sender_-&gt;Update();</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int32_t</span> flag =</span><br><span class="line">      CHECK_RESPONSE_STEER_UNIT_FLAG | CHECK_RESPONSE_SPEED_UNIT_FLAG;</span><br><span class="line">  <span class="keyword">if</span> (!CheckResponse(flag, <span class="literal">true</span>)) &#123;</span><br><span class="line">    AERROR &lt;&lt; <span class="string">"Failed to switch to COMPLETE_AUTO_DRIVE mode."</span>;</span><br><span class="line">    Emergency();</span><br><span class="line">    set_chassis_error_code(Chassis::CHASSIS_ERROR);</span><br><span class="line">    <span class="keyword">return</span> ErrorCode::CANBUS_ERROR;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set_driving_mode(Chassis::COMPLETE_AUTO_DRIVE);</span><br><span class="line">    AINFO &lt;&lt; <span class="string">"Switch to COMPLETE_AUTO_DRIVE mode ok."</span>;</span><br><span class="line">    <span class="keyword">return</span> ErrorCode::OK;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// audi default, -470 ~ 470, left:+, right:-</span></span><br><span class="line"><span class="comment">// need to be compatible with control module, so reverse</span></span><br><span class="line"><span class="comment">// steering with old angle speed</span></span><br><span class="line"><span class="comment">// angle:-99.99~0.00~99.99, unit:, left:-, right:+</span></span><br><span class="line"><span class="keyword">void</span> AudiController::Steer(<span class="keyword">double</span> angle) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!(driving_mode() == Chassis::COMPLETE_AUTO_DRIVE ||</span><br><span class="line">        driving_mode() == Chassis::AUTO_STEER_ONLY)) &#123;</span><br><span class="line">    AINFO &lt;&lt; <span class="string">"The current driving mode does not need to set steer."</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// const double real_angle = params_.max_steer_angle() * angle / 100.0;</span></span><br><span class="line">  <span class="comment">// reverse sign</span></span><br><span class="line">  <span class="comment">/* ADD YOUR OWN CAR CHASSIS OPERATION</span></span><br><span class="line"><span class="comment">  steering_64_-&gt;set_steering_angle(real_angle)-&gt;set_steering_angle_speed(200);</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  inputpositionsteering_20_-&gt;set_inputsteering(angle * <span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>代码文件为<code>audi_control.cc</code></p>
</blockquote>
<p>但测试时并不是只有control模块能做这件事，只要起一个rosnode，不断发布控制指令即可。有一个工具，<code>teleop</code>就是这个逻辑。</p>
<p>启动逻辑：</p>
<ol>
<li><code>m1</code> 强制进入自动驾驶模式；</li>
<li>发送控制指令（比如转向），如果错误检查canbus模块输出，如果是默认情况，此处有坑。</li>
</ol>
<p>如果是默认情况，控制信号经过了<code>Guardian</code>模块，但是该字段先在gflags里面有设置为false，如下所示：<br><figure class="highlight cc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// enable receiving guardian command</span></span><br><span class="line"><span class="comment">// TODO(QiL) : depreciate this after test</span></span><br><span class="line">DEFINE_bool(receive_guardian, <span class="literal">false</span>,</span><br><span class="line">            <span class="string">"Enable receiving guardian message on canbus side"</span>);</span><br></pre></td></tr></table></figure></p>
<p>而后又在配置文件中置为了true，导致控制指令的走向排查错了方向。</p>
<figure class="highlight cc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// TODO(QiL) : depreacte this</span></span><br><span class="line"><span class="keyword">if</span> (!FLAGS_receive_guardian) &#123;</span><br><span class="line">  AdapterManager::AddControlCommandCallback(&amp;Canbus::OnControlCommand, <span class="keyword">this</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  AdapterManager::AddGuardianCallback(&amp;Canbus::OnGuardianCommand, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有别的异常，先在就可以进入自动驾驶欧式了。<br>如果有问题？确保打开所有级别的日志信息，不要错过任何代码中插入的日志关键字作为检查项；<br>如何打开？在<code>modules/canbus/conf/canbus.conf</code>中增加<code>--v=4</code> 或者<code>logbuflevel=4</code>均可。</p>
<h2 id="5、信号控制问题"><a href="#5、信号控制问题" class="headerlink" title="5、信号控制问题"></a>5、信号控制问题</h2><p>1、车辆速度信号（0x708）反馈单位，’physical_unit’: ‘KMH’ 但拿到的值跟现实不符；<br>real_value = raw_value * factor + offset</p>
<p>2、角度需要标注出正负角度，这样才能知道转向；</p>
<h2 id="参考日志"><a href="#参考日志" class="headerlink" title="参考日志"></a>参考日志</h2><h3 id="1、不能识别控制信号和反馈信号导致的一个编译错误"><a href="#1、不能识别控制信号和反馈信号导致的一个编译错误" class="headerlink" title="1、不能识别控制信号和反馈信号导致的一个编译错误"></a>1、不能识别控制信号和反馈信号导致的一个编译错误</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ERROR: /apollo/modules/canbus/vehicle/audi/BUILD:36:1: C++ compilation of rule <span class="string">'//modules/canbus/vehicle/audi:audi_controller'</span> failed (Exit 1)</span><br><span class="line">modules/canbus/vehicle/audi/audi_controller.cc: In member <span class="keyword">function</span> <span class="string">'virtual apollo::canbus::Chassis apollo::canbus::audi::AudiController::chassis()'</span>:</span><br><span class="line">modules/canbus/vehicle/audi/audi_controller.cc:204:87: error: no matching <span class="keyword">function</span> <span class="keyword">for</span> call to <span class="string">'apollo::canbus::Chassis::set_gear_location(apollo::canbus::Gearposition_704_GearpositionType)'</span></span><br><span class="line">     chassis_.set_gear_location(chassis_detail.audi().gearposition_704().gearposition());</span><br><span class="line">                                                                                       ^</span><br><span class="line">modules/canbus/vehicle/audi/audi_controller.cc:204:87: note: candidate is:</span><br><span class="line">In file included from bazel-out/<span class="built_in">local</span>-opt/genfiles/modules/canbus/proto/vehicle_parameter.pb.h:33:0,</span><br><span class="line">                 from bazel-out/<span class="built_in">local</span>-opt/genfiles/modules/canbus/proto/canbus_conf.pb.h:33,</span><br><span class="line">                 from ./modules/canbus/vehicle/vehicle_controller.h:27,</span><br><span class="line">                 from ./modules/canbus/vehicle/audi/audi_controller.h:23,</span><br><span class="line">                 from modules/canbus/vehicle/audi/audi_controller.cc:16:</span><br><span class="line">bazel-out/<span class="built_in">local</span>-opt/genfiles/modules/canbus/proto/chassis.pb.h:2248:13: note: void apollo::canbus::Chassis::set_gear_location(apollo::canbus::Chassis_GearPosition)</span><br><span class="line"> inline void Chassis::set_gear_location(::apollo::canbus::Chassis_GearPosition value) &#123;</span><br><span class="line">             ^</span><br><span class="line">bazel-out/<span class="built_in">local</span>-opt/genfiles/modules/canbus/proto/chassis.pb.h:2248:13: note:   no known conversion <span class="keyword">for</span> argument 1 from <span class="string">'apollo::canbus::Gearposition_704_GearpositionType'</span> to <span class="string">'apollo::canbus::Chassis_GearPosition'</span></span><br></pre></td></tr></table></figure>
<p>1、不断从进入自动驾驶到人工驾驶循环；<br>2、下发报文如何调试？</p>
<h3 id="2、未能正确进入自动驾驶模式，且有信号超时的部分日志"><a href="#2、未能正确进入自动驾驶模式，且有信号超时的部分日志" class="headerlink" title="2、未能正确进入自动驾驶模式，且有信号超时的部分日志"></a>2、未能正确进入自动驾驶模式，且有信号超时的部分日志</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">==&gt; canbus.in_dev_docker.apollo.log.INFO.20180810-104824.18243 &lt;==</span><br><span class="line">I0810 10:48:25.780036 18243 canbus.cc:42] The adapter manager is successfully initialized.</span><br><span class="line">I0810 10:48:25.780200 18243 canbus.cc:50] The canbus conf file is loaded: modules/canbus/conf/canbus_conf_audi.pb.txt</span><br><span class="line">I0810 10:48:25.780205 18243 can_client_factory.cc:38] CanClientFactory::RegisterCanClients</span><br><span class="line">I0810 10:48:25.780207 18243 can_client_factory.cc:42] register can: 1</span><br><span class="line">I0810 10:48:25.780210 18243 canbus.cc:60] Can client is successfully created.</span><br><span class="line">I0810 10:48:25.780231 18243 canbus.cc:74] Message manager is successfully created.</span><br><span class="line">I0810 10:48:25.780232 18243 canbus.cc:80] The can receiver is successfully initialized.</span><br><span class="line">I0810 10:48:25.780234 18243 canbus.cc:86] The can sender is successfully initialized.</span><br><span class="line">I0810 10:48:25.780237 18243 canbus.cc:92] The vehicle controller is successfully created.</span><br><span class="line">I0810 10:48:25.780239 18243 can_sender.h:355] Add send message:300</span><br><span class="line">I0810 10:48:25.780241 18243 can_sender.h:355] Add send message:21</span><br><span class="line">I0810 10:48:25.780243 18243 can_sender.h:355] Add send message:20</span><br><span class="line">I0810 10:48:25.780244 18243 audi_controller.cc:95] AudiController is initialized.</span><br><span class="line">I0810 10:48:25.780246 18243 canbus.cc:98] The vehicle controller is successfully initialized.</span><br><span class="line">I0810 10:48:25.780313 18243 canbus.cc:117] Can client is started.</span><br><span class="line">I0810 10:48:25.780396 18243 canbus.cc:123] Can receiver is started.</span><br><span class="line">I0810 10:48:25.780433 18276 can_receiver.h:132] Can client receiver thread starts.</span><br><span class="line">I0810 10:48:25.780463 18277 can_sender.h:287] Can client sender thread starts.</span><br><span class="line">W0810 10:50:42.182757 18277 can_sender.h:321] Too much time <span class="keyword">for</span> calculation: 7235us is more than minimum period: 5000us</span><br></pre></td></tr></table></figure>
<h3 id="3、不断循环进入退出自动驾驶模式的日志（主要是经过了guardian模块的原因）："><a href="#3、不断循环进入退出自动驾驶模式的日志（主要是经过了guardian模块的原因）：" class="headerlink" title="3、不断循环进入退出自动驾驶模式的日志（主要是经过了guardian模块的原因）："></a>3、不断循环进入退出自动驾驶模式的日志（主要是经过了guardian模块的原因）：</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">I0810 15:57:18.231076  6434 guardian.cc:140] Emergency stop triggered! with system status from monitor as : 1</span><br><span class="line">I0810 15:57:18.241261  6434 guardian.cc:105] Safety state triggered, with system safety mode trigger time : 1.53389e+09</span><br><span class="line">I0810 15:57:18.241408  6434 guardian.cc:111] Ultrasonic sensor not enabled <span class="keyword">for</span> faulted, will <span class="keyword">do</span> emergency stop!</span><br><span class="line">I0810 15:57:18.241425  6434 guardian.cc:135] Temporarily ignore the ultrasonic sensor output during hardware re-alignment!</span><br><span class="line">I0810 15:57:18.241430  6434 guardian.cc:140] Emergency stop triggered! with system status from monitor as : 1</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">I0812 12:33:13.169888 23298 message_manager.h:173] [DEBUG] Unable to get protocol data because of invalid message_id:0430</span><br><span class="line">I0812 12:33:13.169898 23298 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0430,len:8,data:0000000000000000,</span></span><br><span class="line">I0812 12:33:13.170135 23299 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 12:33:13.170385 23298 message_manager.h:173] [DEBUG] Unable to get protocol data because of invalid message_id:0431</span><br><span class="line">I0812 12:33:13.170395 23298 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0431,len:8,data:0000000000000000,</span></span><br><span class="line">I0812 12:33:13.170619 23299 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0020,len:8,data:FF3F000000000000,</span></span><br><span class="line">I0812 12:33:13.170882 23298 message_manager.h:173] [DEBUG] Unable to get protocol data because of invalid message_id:0432</span><br><span class="line">I0812 12:33:13.170893 23298 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0432,len:8,data:0000000000000000,</span></span><br><span class="line">I0812 12:33:13.171130 23298 message_manager.h:173] [DEBUG] Unable to get protocol data because of invalid message_id:0433</span><br><span class="line">I0812 12:33:13.171139 23298 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0433,len:8,data:0000000000000000,</span></span><br><span class="line">I0812 12:33:13.171386 23298 message_manager.h:173] [DEBUG] Unable to get protocol data because of invalid message_id:0434</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">I0812 12:36:34.143390 23298 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0336,len:8,data:10FFFF9430010000,</span></span><br><span class="line">I0812 12:36:34.143630 23298 message_manager.h:173] [DEBUG] Unable to get protocol data because of invalid message_id:0335</span><br><span class="line">I0812 12:36:34.143640 23298 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0335,len:8,data:0000000000000000,</span></span><br><span class="line">I0812 12:36:34.144309 23299 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0300,len:8,data:2000000100000000,</span></span><br><span class="line">I0812 12:36:34.144629 23299 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 12:36:34.144863 23266 canbus.cc:152] [DEBUG] engine_started: <span class="literal">true</span> engine_rpm: 679 speed_mps: 0 fuel_range_m: 0 throttle_percentage: 0 steering_percentage: 16285 parking_brake: <span class="literal">true</span> driving_mode: COMPLETE_AUTO_DRIVE error_code: NO_ERROR gear_location: GEAR_PARKING header &#123; timestamp_sec: 1534048594.1447713 module_name: <span class="string">"chassis"</span> sequence_num: 44954 &#125; signal &#123; turn_signal: TURN_NONE &#125; engage_advice &#123; advice: DISALLOW_ENGAGE reason: <span class="string">"CANBUS not ready, firmware error or emergency button pressed!"</span> &#125; wheel_speed &#123; wheel_spd_rr: 0 wheel_spd_rl: 0 wheel_spd_fr: 0 wheel_spd_fl: 0 &#125;</span><br><span class="line">I0812 12:36:34.144919 23299 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0020,len:8,data:FF3F000000000000,</span></span><br></pre></td></tr></table></figure>
<h3 id="转向调试"><a href="#转向调试" class="headerlink" title="转向调试"></a>转向调试</h3><p>监听油门踏板信号的发送数据：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apollo@in_dev_docker:/apollo/data/<span class="built_in">log</span>$ tail -f canbus.INFO | grep <span class="string">"send_can_frame#id:0x0300"</span></span><br><span class="line">I0812 13:15:57.172904 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0300,len:8,data:2000000100000000,</span></span><br><span class="line">I0812 13:15:57.193202 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0300,len:8,data:2000000100000000,</span></span><br><span class="line">I0812 13:15:57.214828 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0300,len:8,data:2000000100000000,</span></span><br><span class="line">I0812 13:15:57.234797 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0300,len:8,data:2000000100000000,</span></span><br><span class="line">I0812 13:15:57.255151 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0300,len:8,data:2000000100000000,</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apollo@in_dev_docker:/apollo/data/<span class="built_in">log</span>$ tail -f canbus.INFO | grep <span class="string">"recv_can_frame#id:0x0124"</span></span><br><span class="line">I0812 13:17:39.439062 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0124,len:8,data:8E539D53C0538E53,</span></span><br><span class="line">I0812 13:17:39.459025 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0124,len:8,data:8E539D53C0538E53,</span></span><br><span class="line">I0812 13:17:39.478745 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0124,len:8,data:C0539D53C0538E53,</span></span><br><span class="line">I0812 13:17:39.499053 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0124,len:8,data:8E539D53C0538E53,</span></span><br><span class="line">I0812 13:17:39.519502 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0124,len:8,data:8E539D53C0538E53,</span></span><br><span class="line">I0812 13:17:39.539433 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0124,len:8,data:8E539D53C0538E53,</span></span><br></pre></td></tr></table></figure>
<p><strong>转向反馈信号</strong><br>在测试过程中发现的测试问题，发现油门过大。<br><figure class="highlight cc"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(!chassis_detail.audi().has_gaspedal_706() ||</span><br><span class="line">!chassis_detail.audi().gaspedal_706().has_gaspedalposition()) &#123;</span><br><span class="line">  chassis_.set_throttle_percentage(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (chassis_detail.audi().has_gaspedal_706() &amp;&amp;</span><br><span class="line">    chassis_detail.audi().gaspedal_706().has_gaspedalposition()) &#123;</span><br><span class="line">  chassis_.set_throttle_percentage(</span><br><span class="line">      chassis_detail.audi().gaspedal_706().gaspedalposition());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="油门调试"><a href="#油门调试" class="headerlink" title="油门调试"></a>油门调试</h3><p>监听油门踏板信号的发送数据：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apollo@in_dev_docker:/apollo/data/<span class="built_in">log</span>$ tail -f canbus.INFO | grep <span class="string">"send_can_frame#id:0x0021"</span></span><br><span class="line">I0812 13:05:15.805725 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 13:05:15.826007 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 13:05:15.846329 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 13:05:15.866488 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 13:05:15.886785 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 13:05:15.907239 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br><span class="line">I0812 13:05:15.927361 24344 can_sender.h:309] [DEBUG] send_can_frame<span class="comment">#id:0x0021,len:8,data:FE3F000000000000,</span></span><br></pre></td></tr></table></figure></p>
<p>油门的反馈数据：<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">I0812 13:01:52.416574 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0B00,</span></span><br><span class="line">I0812 13:01:52.625324 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0B00,</span></span><br><span class="line">I0812 13:01:52.825000 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0A00,</span></span><br><span class="line">I0812 13:01:53.025012 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0001,</span></span><br><span class="line">I0812 13:03:49.036394 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0000,</span></span><br><span class="line">I0812 13:03:49.236274 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0000,</span></span><br><span class="line">I0812 13:03:49.436159 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0000,</span></span><br><span class="line">I0812 13:03:49.636353 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0000,</span></span><br><span class="line">I0812 13:03:49.835999 24343 can_receiver.h:175] [DEBUG] recv_can_frame<span class="comment">#id:0x0706,len:2,data:0000,</span></span><br></pre></td></tr></table></figure></p>
<p>CAN可以接收到frame，但是通过teleop下发的数据无变化。初步怀疑是超过值的范围了？</p>
<h3 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h3><p>在增加换挡前检查底盘信号逻辑之后，换N档有问题。不影响测试，留待之后解决。</p>
<h3 id="发现的一些问题："><a href="#发现的一些问题：" class="headerlink" title="发现的一些问题："></a>发现的一些问题：</h3><p>1、docker镜像缺失或者scipy版本需要升级，执行轨迹回放功能报错：rtk_play.sh<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">```</span><br><span class="line"></span><br><span class="line">2、安装完kernel后，执行grub时，并没有默认加载，需要手动修改grub加载指定内核版本才可以。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3、在6108GC工控机上实际安装docker的过程中，在未安装apollo-kernel之前，因为底层文件系统驱动类型的原因（overlay、devicemapper不适配）</span><br><span class="line"></span><br><span class="line">4、运行速度标定报错，just like :python data_collector.py calibration_data_sample/b13_up.txt</span><br><span class="line"></span><br><span class="line">AttributeError: <span class="string">'DataCollector'</span> object has no attribute <span class="string">'in_session'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### 20180815今日计划</span></span><br><span class="line"></span><br><span class="line">0、检查所有信号的反馈系数是否已经处理，否则拿到的数据不够准确，导致车辆控制失衡；</span><br><span class="line">1、修改timezone=50北京，解决车辆在dreamview中偏离车道的情况；</span><br><span class="line">localization.conf和common/data/global.conf</span><br><span class="line"></span><br><span class="line">```conf</span><br><span class="line">--local_utm_zone_id=10</span><br></pre></td></tr></table></figure></p>
<p>2、测试人工驾驶过程中对油门量的收集<br>3、循迹驾驶能力测试；</p>
<p>主要测试</p>
<ul>
<li>修复启动canbus模块，档位默认进入D档；</li>
<li>【待解决】在Dreamview画面中，规划出的路径在车后放。 </li>
</ul>
<p><img src="http://agroup-bos.su.bcebos.com/b7be4a55b7cdf6c20ccf1317fc6c06cd8175faf7" alt="图片"><br>测试发现，油门量下发10%，但是从706信号拿，只拿到了4.8;经过修正，从123信号获取油门量正常，补充获取刹车值。</p>
<ul>
<li>经过Planning下发的加速度也正常，但经过control模块的处理之后，油门量变化为24~30%，这个过程有问题。</li>
</ul>
<h3 id="20180816今日计划"><a href="#20180816今日计划" class="headerlink" title="20180816今日计划"></a>20180816今日计划</h3><p>1、排查轨迹线后向的问题，最新的PP7配置如下表，其中的差异是去掉了对IMU型号的设置。另外，确认gnss_conf.pb.txt中也需要将<code>zone</code>设置为北京。<br><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">// CONNECTIMU SPI EPSON_G320 </span><br><span class="line">SETINSTRANSLATION ANT1 -0.475 0.340 0.714 0.05 0.05 0.08  </span><br><span class="line">SETINSTRANSLATION ANT2 0.475 0.340 0.714 0.05 0.05 0.08  </span><br><span class="line">SETINSROTATION RBV 0 0 0 1 1 1</span><br><span class="line">SETINSPROFILE LAND_PLUS</span><br><span class="line">ALIGNMENTMODE AUTOMATIC </span><br><span class="line">其他相关配置：</span><br><span class="line">WIFICONFIG STATE OFF</span><br><span class="line">UNLOGALL THISPORT</span><br><span class="line">INSCOMMAND ENABLE</span><br><span class="line">SERIALCONFIG COM1 9600 N 8 1 N OFF</span><br><span class="line">SERIALCONFIG COM2 9600 N 8 1 N OFF</span><br><span class="line">INTERFACEMODE COM1 NOVATEL NOVATEL ON</span><br><span class="line">INTERFACEMODE USB2 RTCMV3 NONE OFF</span><br><span class="line">PPSCONTROL ENABLE POSITIVE 1.0 10000</span><br><span class="line">MARKCONTROL MARK1 ENABLE POSITIVE</span><br><span class="line">EVENTINCONTROL MARK1 ENABLE POSITIVE 0 2</span><br><span class="line">RTKSOURCE AUTO ANY</span><br><span class="line">PSRDIFFSOURCE AUTO ANY</span><br><span class="line">EVENTOUTCONTROL MARK2 ENABLE POSITIVE 999999990 10</span><br><span class="line">EVENTOUTCONTROL MARK1 ENABLE POSITIVE 500000000 500000000</span><br><span class="line">指令输出配置：</span><br><span class="line">LOG COM2 GPRMC ONTIME 1.0 0.25</span><br><span class="line">LOG USB1 GPGGA ONTIME 1.0</span><br><span class="line">LOG USB1 BESTGNSSPOSB ONTIME 1</span><br><span class="line">LOG USB1 BESTGNSSVELB ONTIME 1</span><br><span class="line">LOG USB1 BESTPOSB ONTIME 1</span><br><span class="line">LOG USB1 INSPVAXB ONTIME 1</span><br><span class="line">LOG USB1 INSPVASB ONTIME 0.01</span><br><span class="line">LOG USB1 CORRIMUDATASB ONTIME 0.01</span><br><span class="line">LOG USB1 RAWIMUSXB ONNEW 0 0</span><br><span class="line">LOG USB1 MARK1PVAB ONNEW</span><br><span class="line"> </span><br><span class="line">LOG USB1 RANGEB ONTIME 1</span><br><span class="line">LOG USB1 BDSEPHEMERISB ONTIME 15</span><br><span class="line">LOG USB1 GPSEPHEMB ONTIME 15</span><br><span class="line">LOG USB1 GLOEPHEMERISB ONTIME 15</span><br><span class="line"> </span><br><span class="line">LOG USB1 INSCONFIGB ONCE</span><br><span class="line">LOG USB1 VEHICLEBODYROTATIONB ONCHANGED</span><br><span class="line"> </span><br><span class="line">SAVECONFIG</span><br></pre></td></tr></table></figure></p>
<p>在手动驾驶3圈之后ins align保持耦合，比如查看topic <code>/apollo/sensor/gnss/imu_status</code> 如果是GOOD，标记为聚合状态。</p>
<p><img src="http://agroup-bos.cdn.bcebos.com/eca998a8c5457422d492e4172324053a90083c9f" alt="ins_status"></p>
<p>2、速度表的标定。</p>
<p>设置纵向的速度驾驶模式：<br><figure class="highlight cc"><table><tr><td class="code"><pre><span class="line">ErrorCode AudiController::EnableSpeedOnlyMode() &#123;</span><br><span class="line">  <span class="keyword">if</span> (driving_mode() == Chassis::COMPLETE_AUTO_DRIVE ||</span><br><span class="line">      driving_mode() == Chassis::AUTO_SPEED_ONLY) &#123;</span><br><span class="line">    set_driving_mode(Chassis::AUTO_SPEED_ONLY);</span><br><span class="line">    AINFO &lt;&lt; <span class="string">"Already in AUTO_SPEED_ONLY mode"</span>;</span><br><span class="line">    <span class="keyword">return</span> ErrorCode::OK;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  gatewaycommand_300_-&gt;set_magneticclutch(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  can_sender_-&gt;Update();</span><br><span class="line">  <span class="keyword">if</span> (CheckResponse(CHECK_RESPONSE_SPEED_UNIT_FLAG, <span class="literal">true</span>) == <span class="literal">false</span>) &#123;</span><br><span class="line">    AERROR &lt;&lt; <span class="string">"Failed to switch to AUTO_STEER_ONLY mode."</span>;</span><br><span class="line">    Emergency();</span><br><span class="line">    <span class="keyword">return</span> ErrorCode::CANBUS_ERROR;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    set_driving_mode(Chassis::AUTO_SPEED_ONLY);</span><br><span class="line">    AINFO &lt;&lt; <span class="string">"Switch to AUTO_SPEED_ONLY mode ok."</span>;</span><br><span class="line">    <span class="keyword">return</span> ErrorCode::OK;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>action字段<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">enum DrivingAction &#123;</span><br><span class="line">  STOP = 0;</span><br><span class="line">  START = 1;</span><br><span class="line">  RESET = 2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>通过多次确认，现在确认问题出现在控制模块，油门量的下发反馈和刹车量的下发反馈，均是正常范围。但是从下面这张图，可以说明，<code>throttle</code>和<code>steering_target</code>两个值，在经过control模块控制器的计算后，值发生了很大的变化：<br><img src="http://agroup-bos.cdn.bcebos.com/0650c4faaf3923ca06b61e18780a1bf51263c7b4" alt="图片"></p>
<p>所以经过重新整理，打算从以下几个方面准备明天的控制调参内容：<br>1、因为速度标定工具的原因，选择手动设置一个速度标定查值表。根据speed、command（控制量，正值油门，负值刹车）查找加速度；<br>2、更新控制参数，包括轮胎正压力（车辆质量分布，车身重量除以四）、最大加速度（max_lateral_acceleration）、刹车最小作用值（brake_deadzone）、油门最小作用值（throttle_deadzone）；<br>3、更新PID控制参数查看效果；</p>
<h3 id="20180817计划测试内容"><a href="#20180817计划测试内容" class="headerlink" title="20180817计划测试内容"></a>20180817计划测试内容</h3><p>1、标定表：</p>
<blockquote>
<p>设计思路：因为速度标定工具的原因，选择手动设置一个速度标定查值表。根据speed、command（控制量，正值油门，负值刹车）查找加速度；</p>
</blockquote>
<p>速度变化：0.0 0.2 0.4 0.6 0.8 1.0 1.2 1.4 1.6 1.8 2.0<br>command  dead_zone</p>
<p>2、更新的车辆设备参数：</p>
<p>audi_q7.pb.txt<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  mass_fl: 618 轮胎正压力 （质量分布，与车身质量相关，与控制精度强相关）  2220 + 100(battery +ipc + sensor) + 150 =2470</span><br><span class="line">  mass_fr: 618</span><br><span class="line">  mass_rl: 618</span><br><span class="line">  mass_rr: 618</span><br><span class="line">max_lateral_acceleration: ？ 最大加速度（之前孙婉的反馈结果是跟模式、档位有关，只要D档位）</span><br><span class="line">brake_deadzone: ？ 受作用刹车最小值</span><br><span class="line">throttle_deadzone: ？ 受作用油门最小值</span><br></pre></td></tr></table></figure></p>
<p>vehicle_param.pb.txt<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">min_turn_radius: 5.05386147161</span><br><span class="line">max_acceleration: 2.0</span><br><span class="line">max_deceleration: -6.0</span><br><span class="line"></span><br><span class="line">max_steer_angle: 8.20304748437</span><br><span class="line">max_steer_angle_rate: 6.98131700798</span><br><span class="line">steer_ratio: 15.8</span><br><span class="line">wheel_base: 3.001 // MKZ 2.8448 轴距 need update</span><br><span class="line">wheel_rolling_radius: 0.335 轮胎半径</span><br></pre></td></tr></table></figure></p>
<h3 id="20180818-计划"><a href="#20180818-计划" class="headerlink" title="20180818 计划"></a>20180818 计划</h3><p>控制模块<br>车的纵向控制部分是一个PID配合一个标定表写的。这部分的标定表要配合车型来做。<br>车的横向控制部分是一个基于车辆坐标系的LQR控制器。控制器追踪路径上最近的一个点。</p>
<p>今天主要的两个问题：<br>1、PP7必须通过重启确保IMU与GPS的耦合效果；<br>2、横向控制精度的问题；</p>
<p>今天主要记录探索横向控制精度的问题。</p>
<p>输出给车辆的转向字段为<code>steering_target</code>，而这个字段是怎么来的？来自于横向控制器（lat_controller）中的<code>steer_angle</code> 字段。</p>
<p>有关这几个字段的核心处理过程大致如下：<br><figure class="highlight cc"><table><tr><td class="code"><pre><span class="line"><span class="comment">// feedback = - K * state</span></span><br><span class="line"><span class="comment">// Convert vehicle steer angle from rad to degree and then to steer degree</span></span><br><span class="line"><span class="comment">// then to 100% ratio</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> steer_angle_feedback = -(matrix_k_ * matrix_state_)(<span class="number">0</span>, <span class="number">0</span>) * <span class="number">180</span> /</span><br><span class="line">                                    M_PI * steer_ratio_ /</span><br><span class="line">                                    steer_single_direction_max_degree_ * <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">double</span> steer_angle_feedforward = ComputeFeedForward(debug-&gt;curvature());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Clamp the steer angle to -100.0 to 100.0</span></span><br><span class="line"><span class="keyword">double</span> steer_angle = common::math::Clamp(</span><br><span class="line">    steer_angle_feedback + steer_angle_feedforward, <span class="number">-100.0</span>, <span class="number">100.0</span>);</span><br></pre></td></tr></table></figure></p>
<p>根据录制的一段轨迹，比如在开头的位置，我们的转向百分比应该在<code>3.2</code>左右：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">x,y,z,speed,acceleration,curvature,curvature_change_rate,time,theta,gear,s,throttle,brake,steering</span><br><span class="line">433418.997103, 4437853.79853, 34.5846617715, 0.105555556715, 0.334852695177, 0.00620212670632, 0.0, 1534586322.7593, 1.19223495886, 1, 0.00105555556715, 0.0, -49.7436485291, 3.20000004768</span><br></pre></td></tr></table></figure></p>
<p>而我期望，最后给车辆下发的也应该是这个值。而在起初，这个转角在经过Apollo控制的计算之后，给出的角度在3.79318左右。显然，应该让这个值再小点，</p>
<p><img src="http://agroup-bos.cdn.bcebos.com/0b525896adc431ec4831801c33dffc888c95c478" alt="非调参下的角度值"></p>
<p>所以我开始调整对转向来说影响较大的<code>matrix_q</code> 矩阵。</p>
<p>第一次调整：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">matrix_q: 0.5</span><br><span class="line">matrix_q: 0.0</span><br><span class="line">matrix_q: 0.01</span><br><span class="line">matrix_q: 0.0</span><br></pre></td></tr></table></figure></p>
<p>调整之后的<code>simple_lat_debug</code></p>
<p><img src="http://agroup-bos.cdn.bcebos.com/43112499d7a7a8fea2081b8659f5ea3f02bf39e7" alt="图片"><br>还是略大，需要再次调整。<br>第二次调整：</p>
<pre><code class="txt">matrix_q: 1.0
matrix_q: 0.0
matrix_q: 0.01
matrix_q: 0.0
</code></pre>
<p>起始点横向控制1：<br><img src="http://agroup-bos.cdn.bcebos.com/d0469d8bec5dedb50c729b026e8a8c5560d1d144" alt="图片"></p>
<p>起始点横向控制参数2：<br><img src="http://agroup-bos.cdn.bcebos.com/273fef5ca468dc7c3620ea726633b74f0ba1ee2e" alt="图片"></p>
<p>对<code>matrix_q:1.0</code>的尝试，失败。</p>
<p>最后调整参数如下，完成了环形的循迹自动驾驶能力测试：</p>
<pre><code class="txt">matrix_q: 0.01
matrix_q: 0.0
matrix_q: 0.1
matrix_q: 0.0
</code></pre>
<p>至此，在适配一辆新车型时，设计到的Canbus模块，control模块，就一一适配完成了。</p>
<p>速度的标定</p>
<p>溜车的情况</p>
<p>最后一脚未刹停</p>


  
    <div class="comments" id="comments">
      
        <div onclick="showGitment()" id="gitment-display-button">如果你有不同看法？</div>
        <div id="gitment-container" style="display:none"></div>
      
    </div>
  

<div style="display:none">
<script src="http://s4.cnzz.com/stat.php?id=1254090228&web_id=1254090228" language="JavaScript"></script>script>
</div>




    
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    



      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.href, 
            owner: 'mickeyouyou',
            repo: 'blog_comment',
            
            lang: "en" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: '27804beebc0d0aa2ae7271191fd5adac6d1b8cb7',
            
                client_id: '57e78fbfba943c338437'
            }});
        gitment.render('gitment-container');
      }

      
          function showGitment(){
            document.getElementById("gitment-display-button").style.display = "none";
            document.getElementById("gitment-container").style.display = "block";
            renderGitment();
          }
      
      </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
    




</body>
</html>